import*as r from"three";import{EffectComposer as Nt}from"three/addons/postprocessing/EffectComposer.js";import{RenderPass as _t}from"three/addons/postprocessing/RenderPass.js";import{UnrealBloomPass as Bt}from"three/addons/postprocessing/UnrealBloomPass.js";import"three/addons/postprocessing/OutputPass.js";import"three/addons/postprocessing/FXAAPass.js";import{GLTFLoader as ft}from"three/addons/loaders/GLTFLoader.js";import{DRACOLoader as Ot}from"three/addons/loaders/DRACOLoader.js";import{init as Ht,importNavMesh as Gt,NavMeshQuery as gt}from"@recast-navigation/core";import{threeToSoloNavMesh as Ut}from"@recast-navigation/three";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();const G=new r.Scene;G.background=new r.Color(1710618);const d=new r.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);d.position.set(0,5.4,-4.3);d.rotation.set(-3,0,3.121154018741333);const T=new r.WebGLRenderer({antialias:!1,powerPreference:"high-performance",stencil:!1,depth:!0}),pt=document.getElementById("canvas-container");function ht(){const e=pt.getBoundingClientRect();return{width:e.width,height:e.height}}const ke=ht();T.setSize(ke.width,ke.height);T.setPixelRatio(Math.min(window.devicePixelRatio,1.5));d.aspect=ke.width/ke.height;d.updateProjectionMatrix();setTimeout(()=>{window.dispatchEvent(new Event("resize"))},100);T.shadowMap.enabled=!1;T.toneMapping=r.NoToneMapping;T.outputColorSpace=r.SRGBColorSpace;pt.appendChild(T.domElement);const v=T.domElement;let xe=()=>{const e=ht();d.aspect=e.width/e.height,d.updateProjectionMatrix(),T.setSize(e.width,e.height),T.setPixelRatio(Math.min(window.devicePixelRatio,1.5))};window.addEventListener("resize",xe);function Yt(e){window.removeEventListener("resize",xe),xe=e,window.addEventListener("resize",xe)}function Je(){const e=new r.AmbientLight(16777215,.2);G.add(e),G.fog=new r.Fog(1710618,20,60)}const qt="modulepreload",Xt=function(e){return"/"+e},Ze={},wt=function(n,o,t){let i=Promise.resolve();if(o&&o.length>0){let g=function(h){return Promise.all(h.map(L=>Promise.resolve(L).then(a=>({status:"fulfilled",value:a}),a=>({status:"rejected",reason:a}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=c?.nonce||c?.getAttribute("nonce");i=g(o.map(h=>{if(h=Xt(h),h in Ze)return;Ze[h]=!0;const L=h.endsWith(".css"),a=L?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${a}`))return;const m=document.createElement("link");if(m.rel=L?"stylesheet":qt,L||(m.as="script"),m.crossOrigin="",m.href=h,l&&m.setAttribute("nonce",l),document.head.appendChild(m),L)return new Promise((f,u)=>{m.addEventListener("load",f),m.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${h}`)))})}))}function s(c){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=c,window.dispatchEvent(l),!l.defaultPrevented)throw c}return i.then(c=>{for(const l of c||[])l.status==="rejected"&&s(l.reason);return n().catch(s)})},_=1.6,Pe={x:5,y:10,z:5},ae={emissive:new r.Color(16777215),emissiveIntensity:1,color:new r.Color(16777215),toneMapped:!1,transparent:!1,opacity:1};function Te(e,n){if(!n)return;const o=Array.isArray(n.material)?n.material[0]:n.material;if(!o){n.material=new r.MeshStandardMaterial({map:e,emissiveMap:e,...ae});return}o.map&&o.map.dispose(),o.emissiveMap&&o.emissiveMap.dispose(),o.map=e,o.emissiveMap=e,Object.assign(o,ae),o.needsUpdate=!0}function Ie(e){e.flipY=!0,e.wrapS=r.RepeatWrapping,e.wrapT=r.RepeatWrapping,e.repeat.x=-1,e.colorSpace=r.SRGBColorSpace,e.center.set(.5,.5),e.needsUpdate=!0}function re(e){return Array.isArray(e.material)?e.material[0]:e.material}function vt(e){!e||!e.children||(e.children=e.children.filter(Boolean),e.children.forEach(n=>vt(n)))}function N(e,n){if(!e)return;const o=[e];for(;o.length;){const t=o.pop();if(t&&(n(t),t.children&&t.children.length))for(let i=t.children.length-1;i>=0;i--){const s=t.children[i];s&&typeof s.traverse=="function"?o.push(s):t.children.splice(i,1)}}}let Ke={cameraHeight:1.6,navmeshSearchBox:{x:5,y:10,z:5},screenMaterialSettings:{emissive:[1,1,1],emissiveIntensity:1,color:[1,1,1],toneMapped:!1,transparent:!1,opacity:1},ledCount:384,ledRadius:.03},Ye=.02,ne={sensitivity:.002,rotationSpeed:120},ze={x:0,y:5.4,z:-4.3},De={x:-3,y:0,z:3.121154018741333},Le={x:0,y:0,z:0},Ee={x:0,y:0,z:0},O={enabled:!0,strength:1.5,radius:.4,threshold:.85},y={pulseSpeed:2,pulseWidth:.3,baseIntensity:0,maxIntensity:4,mirrored:!1,rimVisible:!1,hueStart:.5,hueRange:.3,saturation:1,lightness:.5},F={backgroundColor:"#000000",textColor:"#ffffff",dotColor:"#ffffff",sidebarColor:"#333333",sidebarVisible:!0,headerIslandVisible:!1,blendMode:"normal",vignette:{enabled:!1,size:8,fadeWidth:2}},qe={enabled:!0,scrollTimeout:25,touchThreshold:30,snapThreshold:.5,initialSnapThreshold:1,gridColumns:16,gridRows:16},yt={rows:8},Xe={defaultImage:"assets/img/background-text.jpg"},Q={enabled:!0,speed:.02},B={canvas:{backgroundColor:"#000000",backgroundImage:null},about:{backgroundColor:"#463434",backgroundImage:null},team:{backgroundColor:"#000000",backgroundImage:null}};async function Qt(e=!1){try{const n=new URL(import.meta.url),o=new URL("default-settings.json",n);console.log("Loading default-settings.json from:",o.href);const t=e?`${o}?t=${Date.now()}`:o,i=await fetch(t);if(!i.ok)return console.warn("Could not load default-settings.json, using hardcoded defaults"),!1;const s=await i.json();return s.constants&&(Ke={...Ke,...s.constants}),s.settings&&(bt(s.settings),console.log("Default settings loaded from JSON file")),!0}catch(n){return console.warn("Failed to load default settings from JSON:",n),!1}}function bt(e){e.moveSpeed!==void 0&&(Ye=e.moveSpeed),e.cameraSettings&&Object.assign(ne,e.cameraSettings),e.startCameraPosition&&Object.assign(ze,e.startCameraPosition),e.startCameraRotation&&Object.assign(De,e.startCameraRotation),e.colorSettings?window.savedColorSettings=e.colorSettings:window.savedColorSettings=null,e.lightSettings?window.savedLightSettings=e.lightSettings:window.savedLightSettings=null,e.bloomSettings&&(Object.assign(O,e.bloomSettings),console.log("Bloom settings loaded from JSON:",O)),e.ledStripSettings&&Object.assign(y,e.ledStripSettings),e.pageColorSettings&&(e.pageColorSettings.vignette&&(F.vignette={...F.vignette,...e.pageColorSettings.vignette}),Object.assign(F,e.pageColorSettings),F.vignette||(F.vignette={enabled:!0,size:8,fadeWidth:2}),Ce()),e.scrollSettings&&Object.assign(qe,e.scrollSettings),e.canvasSettings&&Object.assign(yt,e.canvasSettings),e.screenSettings&&Object.assign(Xe,e.screenSettings),e.textureRotationSettings&&Object.assign(Q,e.textureRotationSettings),e.pageBackgroundSettings&&(Object.assign(B,e.pageBackgroundSettings),Lt())}function Jt(e,n=.5){if(!e)return null;if(e.startsWith("rgba"))return e;if(e.startsWith("rgb")){const t=e.match(/\d+/g);if(t&&t.length>=3)return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${n})`}const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(o){const t=parseInt(o[1],16),i=parseInt(o[2],16),s=parseInt(o[3],16);return`rgba(${t}, ${i}, ${s}, ${n})`}return e}function Lt(){const e=document.querySelectorAll(".page-section");if(e.length>0&&e.length>1&&B.team)for(let n=1;n<e.length;n++){const o=e[n];if(B.team.backgroundColor&&B.team.backgroundColor!=="#000000"){const t=Jt(B.team.backgroundColor,.5);o.style.setProperty("background-color",t,"important")}else o.style.removeProperty("background-color");B.team.backgroundImage?(o.style.setProperty("background-image",`url(${B.team.backgroundImage})`,"important"),o.style.setProperty("background-size","cover","important"),o.style.setProperty("background-position","center","important"),o.style.setProperty("background-repeat","no-repeat","important")):o.style.removeProperty("background-image")}}function Zt(){const e=document.getElementById("canvas-container");if(!e)return;const n=F.vignette||{enabled:!0,size:8,fadeWidth:2};if(!n.enabled){e.style.maskImage="none",e.style.webkitMaskImage="none";return}const o=`${n.size}%`,t=`${n.size+n.fadeWidth}%`,i=`${n.size+n.fadeWidth*2}%`,s=`${100-n.size-n.fadeWidth*2}%`,c=`${100-n.size-n.fadeWidth}%`,l=`${100-n.size}%`,g=`linear-gradient(to right, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${t}, black ${i}, black ${s}, rgba(0, 0, 0, 0.5) ${c}, transparent ${l}, transparent 100%)`,h=`linear-gradient(to bottom, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${t}, black ${i}, black ${s}, rgba(0, 0, 0, 0.5) ${c}, transparent ${l}, transparent 100%)`;e.style.maskImage=`${g}, ${h}`,e.style.maskComposite="intersect",e.style.webkitMaskImage=`${g}, ${h}`,e.style.webkitMaskComposite="source-in"}function Ce(){document.documentElement.style.setProperty("--color-bg",F.backgroundColor),document.documentElement.style.setProperty("--color-text",F.textColor),document.documentElement.style.setProperty("--color-dot",F.dotColor),Zt()}async function Kt(e=!1){const n=await Qt(e);if(!n&&!e)try{const o=localStorage.getItem("domeDreamingSettings");if(!o){Ce();return}const t=JSON.parse(o);bt(t),console.log("Loaded settings from localStorage (JSON file not available)")}catch(o){console.warn("Failed to load settings from localStorage:",o),Ce()}else n&&(console.log("Loaded settings from data.json"),Ce());Lt()}function Et(e,n){try{const o={};e&&Array.isArray(e)&&e.forEach((s,c)=>{const l=re(s.mesh);if(l?.color){const g=s.name||`mesh_${c}`;o[g]={r:l.color.r,g:l.color.g,b:l.color.b}}});const t={};n&&Array.isArray(n)&&n.forEach((s,c)=>{const l=s.name||`light_${c}`;t[l]={r:s.color.r,g:s.color.g,b:s.color.b,intensity:s.intensity}});const i={moveSpeed:Ye,cameraSettings:ne,startCameraPosition:ze,startCameraRotation:De,colorSettings:o,lightSettings:t,bloomSettings:O,ledStripSettings:y,pageColorSettings:F,scrollSettings:qe,canvasSettings:yt,screenSettings:Xe,textureRotationSettings:Q,pageBackgroundSettings:B};localStorage.setItem("domeDreamingSettings",JSON.stringify(i))}catch(o){console.warn("Failed to save settings:",o)}}let q=null,et=null,he=null;function tt(){const n=document.getElementById("canvas-container").getBoundingClientRect(),o=new r.Vector2(n.width,n.height),t=new r.WebGLRenderTarget(o.width,o.height,{type:r.HalfFloatType,samples:0});q=new Nt(T,t),et=new _t(G,d),q.addPass(et);const i=O.enabled!==!1?O.strength:0;he=new Bt(o,i,O.radius,O.threshold),he.enabled=O.enabled!==!1,q.addPass(he),Yt(()=>{const c=document.getElementById("canvas-container").getBoundingClientRect(),l=c.width,g=c.height;d.aspect=l/g,d.updateProjectionMatrix(),T.setSize(l,g),T.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),tn()}),console.log("Post-processing initialized")}function en(){q?q.render():T.render(G,d)}function tn(){if(q){const n=document.getElementById("canvas-container").getBoundingClientRect(),o=n.width,t=n.height;q.setSize(o,t),he&&he.setSize(o,t)}}let x=null,D=null,M=null,$=null,Se=null;function nt(e){x=e}function nn(){return D}function on(){return $}function sn(e=Xe.defaultImage||"assets/media/background.jpg"){if(!x)return;new r.TextureLoader().load(e,o=>{Ie(o),o.rotation=0,Te(o,x),$=o},void 0,()=>{})}function St(e){if(!x)return;const n=new FileReader;n.onload=o=>{new r.TextureLoader().load(o.target.result,i=>{D&&(D.dispose(),D=null),M&&(M.pause(),M.src="",URL.revokeObjectURL(M.src),M=null),$&&$.dispose(),Q.enabled=!1,Ie(i),i.rotation=0,Te(i,x),$=i;const s=re(x);s&&setTimeout(()=>{Object.assign(s,ae),s.needsUpdate=!0},200)},void 0,()=>{})},n.readAsDataURL(e)}function Mt(e){if(!x)return;const n=document.createElement("video");n.src=URL.createObjectURL(e),n.crossOrigin="anonymous",n.loop=!0,n.muted=!0,n.playsInline=!0,n.addEventListener("loadedmetadata",()=>{n.play(),D&&D.dispose(),M&&(M.pause(),M.src="",URL.revokeObjectURL(M.src)),$&&($.dispose(),$=null),Q.enabled=!1;const o=new r.VideoTexture(n);Ie(o),o.minFilter=r.LinearFilter,o.magFilter=r.LinearFilter,o.rotation=0,Te(o,x),D=o,M=n;const t=re(x);t&&setTimeout(()=>{Object.assign(t,ae),t.needsUpdate=!0},200)}),n.addEventListener("error",()=>{})}function an(){if(x){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("Webcam access is not available in your browser.");return}navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(e=>{D&&(D.dispose(),D=null),M&&(M.pause(),M.srcObject=null,M=null),$&&($.dispose(),$=null),Se&&(Se.getTracks().forEach(o=>o.stop()),Se=null),Q.enabled=!1;const n=document.createElement("video");n.srcObject=e,n.autoplay=!0,n.playsInline=!0,n.muted=!0,n.addEventListener("loadedmetadata",()=>{n.play();const o=new r.VideoTexture(n);Ie(o),o.minFilter=r.LinearFilter,o.magFilter=r.LinearFilter,o.rotation=0,Te(o,x),D=o,M=n,Se=e;const t=re(x);t&&setTimeout(()=>{Object.assign(t,ae),t.needsUpdate=!0},200)}),n.addEventListener("error",()=>{alert("Error accessing webcam.")})}).catch(e=>{console.error("Error accessing webcam:",e),alert("Could not access webcam. Please check permissions.")})}}function rn(){const e=document.getElementById("drop-zone");function n(t){t.preventDefault(),t.stopPropagation()}function o(t){if(!x)return;const i=re(x);i&&(t?(i.emissive=new r.Color(38655),i.emissiveIntensity=.8):(Object.assign(i,ae),i.needsUpdate=!0))}document.addEventListener("dragenter",t=>{n(t),e.classList.add("drag-over"),o(!0)},!1),document.addEventListener("dragover",t=>{n(t),e.classList.add("drag-over"),o(!0)},!1),document.addEventListener("dragleave",t=>{n(t),t.clientX===0&&t.clientY===0&&(e.classList.remove("drag-over"),o(!1))},!1),document.addEventListener("drop",t=>{n(t),e.classList.remove("drag-over"),o(!1);const i=t.dataTransfer.files;if(i.length>0){const s=i[0];s.type.startsWith("image/")?St(s):s.type.startsWith("video/")&&Mt(s)}},!1)}let we=!1,fe=null,We=[],J=null;function ln(){return J}async function xt(){if(!we)try{await Ht(),we=!0,cn()}catch(e){console.error("Failed to initialize recast-navigation:",e),we=!0}}async function cn(){if(!we){await xt();return}try{const e=await fetch("assets/models/navmesh.bin");if(e.ok){const n=await e.arrayBuffer(),o=new Uint8Array(n),{navMesh:t}=Gt(o);J=new gt(t),Dt(J),console.log("Navmesh loaded from navmesh.bin"),H&&Pt();return}}catch{console.log("navmesh.bin not found, will generate from GLTF")}dn()}function dn(){new ft().load("assets/models/navmesh.gltf",async n=>{if(fe=n.scene,fe.scale.setScalar(1),fe.visible=!1,N(fe,o=>{o.isMesh&&(We.push(o),o.updateMatrixWorld())}),G.add(fe),We.length>0&&we){const{success:o,navMesh:t}=Ut(We,{cs:.05,ch:.05,walkableRadius:.2});o&&(J=new gt(t),Dt(J),console.log("Navmesh generated from GLTF"))}},void 0,n=>{console.warn("Navmesh GLTF not found:",n)})}function Pt(){if(!J||!H)return;const e={x:d.position.x,y:d.position.y-_,z:d.position.z},n=J.findClosestPoint(e,{halfExtents:Pe});n.success&&(d.position.y=n.point.y+_)}function un(){xt().catch(console.error)}let X=null,k=[],W=null;const b=384,ge=.03;let ee=0,$e=2,be=.3,ie=0,Ae=4,Ve=!1,R={hueStart:.5,hueRange:.3,saturation:1,lightness:.5};function mn(){$e=y.pulseSpeed,be=y.pulseWidth,ie=y.baseIntensity,Ae=y.maxIntensity,Ve=y.mirrored||!1,R.hueStart=y.hueStart,R.hueRange=y.hueRange,R.saturation=y.saturation,R.lightness=y.lightness;const e=y.rimVisible!==void 0?y.rimVisible:!1;Tt(e)}function fn(e){$e=e,y.pulseSpeed=e,le()}function gn(e){be=e,y.pulseWidth=e,le()}function pn(e){ie=e,y.baseIntensity=e,le()}function hn(e){Ae=e,y.maxIntensity=e,le()}function wn(e,n,o,t){R.hueStart=e,R.hueRange=n,R.saturation=o,R.lightness=t,y.hueStart=e,y.hueRange=n,y.saturation=o,y.lightness=t,le()}function vn(e){Ve=e,y.mirrored=e,le()}function le(){wt(()=>Promise.resolve().then(()=>xn),void 0).then(e=>{Et(e.fbxMeshes,e.glbLights)})}function Ct(e){if(!e)return console.warn("findLEDRim: model is null"),null;let n=null;const o=[];return e.traverse(t=>{o.push(t.name||"unnamed");const i=t.name||"",s=i.toLowerCase();(i==="LED_Rim"||i.includes("LED_Rim")||i.includes("LEDRim")||i.includes("led_rim")||s.includes("ledrim")||s.includes("led")&&s.includes("rim"))&&(n=t,console.log(`Found LED rim object: "${t.name}", type: ${t.type||t.constructor.name}`))}),n||console.warn("LED_Rim object not found. Available object names:",o.filter(t=>t).slice(0,20)),n}function kt(e){if(!e){console.warn("LED_Rim object not found");return}X=e,W=new r.Group,W.name="LED_Strip";let n=null;e.traverse(u=>{u.isMesh&&u.geometry&&(n=u.geometry)});const o=new r.Box3;o.setFromObject(e);const t=o.getSize(new r.Vector3);o.getCenter(new r.Vector3);let i=Math.max(t.x,t.z)/2;const s=t.y/2;let c=i*.75;i<.1&&(console.warn(`LED Rim radius too small (${i.toFixed(2)}), using default 5.0`),i=5,c=3.5),console.log(`LED Rim dimensions: outerRadius=${i.toFixed(2)}, innerRadius=${c.toFixed(2)}, height=${s.toFixed(2)}, size:`,t),console.log("Rim object position:",e.position),console.log("Rim object rotation:",e.rotation),console.log("Rim object scale:",e.scale),console.log("Rim object matrix:",e.matrix);let l=[];if(n&&n.attributes&&n.attributes.position){const u=n.attributes.position,w=u.count;console.log(`Found rim geometry with ${w} vertices`);const S=[];for(let p=0;p<w;p++){const P=u.getX(p),ce=u.getY(p),z=u.getZ(p);S.push(new r.Vector3(P,ce,z))}const A=Math.min(...S.map(p=>p.y)),Z=Math.max(...S.map(p=>p.y)),U=Z-A,K=A+U*.1;console.log(`Rim Y range: ${A.toFixed(2)} to ${Z.toFixed(2)}, using bottom Y: ${K.toFixed(2)}`);const I=S.filter(p=>Math.abs(p.y-K)<U*.15).map(p=>{const P=Math.sqrt(p.x*p.x+p.z*p.z);return{vertex:p,distance:P,angle:Math.atan2(p.z,p.x)}}).sort((p,P)=>p.angle-P.angle);if(I.length>10){console.log(`Found ${I.length} bottom edge vertices`);const p=I.reduce((z,V)=>z+V.vertex.x,0)/I.length,P=I.reduce((z,V)=>z+V.vertex.z,0)/I.length,ce=K;new r.Vector3(p,ce,P),I.reduce((z,V)=>{const de=V.vertex.x-p,ue=V.vertex.z-P;return z+Math.sqrt(de*de+ue*ue)},0)/I.length;for(let z=0;z<b;z++){const V=z/b*Math.PI*2;let de=I[0],ue=1/0;for(const Fe of I){const jt=Math.atan2(Fe.vertex.z-P,Fe.vertex.x-p);let me=Math.abs(jt-V);me>Math.PI&&(me=Math.PI*2-me),me<ue&&(ue=me,de=Fe)}const Wt=new r.Vector3(p+Math.cos(V)*c,de.vertex.y,P+Math.sin(V)*c);l.push(Wt)}console.log(`Created ${l.length} evenly distributed LED positions using angular distribution`)}else{console.log(`Not enough bottom vertices (${I.length}), using perfectly evenly distributed circle positions`);for(let p=0;p<b;p++){const P=p/b*Math.PI*2,ce=new r.Vector3(Math.cos(P)*c,K,Math.sin(P)*c);l.push(ce)}}}else{console.log("No rim geometry found, using perfectly evenly distributed circle positions");for(let u=0;u<b;u++){const w=u/b*Math.PI*2,S=new r.Vector3(Math.cos(w)*c,-s,Math.sin(w)*c);l.push(S)}}if(l.length!==b){console.log(`Adjusting positions from ${l.length} to ${b} for even distribution`);const u=[];for(let w=0;w<b;w++){const S=w/b,A=Math.floor(S*l.length),Z=(A+1)%l.length,U=S*l.length-A,K=new r.Vector3().lerpVectors(l[A],l[Z],U);u.push(K)}l=u}const g=new r.CylinderGeometry(ge*.8,ge*.8,ge*.3,8,1),h=new r.MeshStandardMaterial({color:16777215,emissive:65535,emissiveIntensity:0,metalness:0,roughness:.8}),L=new r.Group;L.name="LED_Diffuser";const a=new r.TorusGeometry(c+ge*.2,ge*.15,16,64),m=new r.MeshStandardMaterial({color:16777215,transparent:!0,opacity:.3,roughness:1,metalness:0,side:r.DoubleSide}),f=new r.Mesh(a,m);if(f.position.y=-s,f.rotation.x=Math.PI/2,L.add(f),l.length!==b){for(console.warn(`Position count mismatch: ${l.length} positions, need ${b}. Creating missing positions.`);l.length<b;){const w=l.length/b*Math.PI*2,S=new r.Vector3(Math.cos(w)*c,-s,Math.sin(w)*c);l.push(S)}l=l.slice(0,b)}for(let u=0;u<b&&u<l.length;u++){const w=new r.Mesh(g,h.clone());w.position.copy(l[u]);const S=new r.Vector3(0,l[u].y,0);w.lookAt(S),w.rotateX(Math.PI/2),w.name=`LED_${u}`,k.push({mesh:w,index:u,material:w.material}),W.add(w)}if(e.add(W),e.add(L),W.visible=!0,W.matrixAutoUpdate=!0,console.log(`Created LED strip with ${k.length} pixels (target: ${b}) at inner radius ${c.toFixed(2)}`),console.log(`Positions array length: ${l.length}`),k.length!==b?console.error(`LED count mismatch! Expected ${b}, got ${k.length}`):console.log(`âœ“ Successfully created all ${b} LEDs`),console.log("LED strip group position (local):",W.position),console.log("LED strip group visible:",W.visible),console.log("Rim object visible:",e.visible),k.length>0){const u=k[0].mesh,w=new r.Vector3;u.getWorldPosition(w);const S=new r.Vector3;e.getWorldPosition(S);const A=new r.Quaternion;if(e.getWorldQuaternion(A),console.log("First LED local position:",u.position),console.log("First LED world position:",w),console.log("Rim object world position:",S),console.log("Rim object world rotation:",e.getWorldQuaternion(A)),console.log("Rim object world scale:",e.getWorldScale(new r.Vector3)),k.length>10){const Z=k[Math.floor(k.length/4)].mesh,U=new r.Vector3;Z.getWorldPosition(U),console.log("Quarter LED world position:",U)}}}function Rt(e){k.length!==0&&(ee+=e*$e,k.forEach((n,o)=>{const t=o/b;let i;if(Ve){const L=t-.5,a=Math.abs(L),m=(.5-a+ee)%1,f=(.5-a-ee+1)%1;i=Math.min(m,f)}else i=(t+ee)%1;const s=Math.abs(i-.5)*2;let c=0;s<be?(c=1-s/be,c=Math.pow(c,2),c=ie+(Ae-ie)*c):c=ie,n.material.emissiveIntensity=Math.max(c,0);const l=ee*.1,g=(R.hueStart+(t+ee*.5)*R.hueRange+l)%1,h=new r.Color().setHSL(g,R.saturation,R.lightness);n.material.emissive=h,n.mesh.visible=!0}))}function yn(e){k.forEach(n=>{n.material.emissive.set(e)})}function bn(e){k.forEach(n=>{n.material.emissiveIntensity=e})}function Ln(){return W}function En(){return X}function Tt(e){X&&(X.visible=e,X.traverse(n=>{n.isMesh&&(n.visible=e)}))}function Sn(){return X?X.visible:!0}const Mn=Object.freeze(Object.defineProperty({__proto__:null,get baseIntensity(){return ie},colorPalette:R,createLEDStrip:kt,findLEDRim:Ct,getLEDStrip:Ln,getRimObject:En,isRimVisible:Sn,loadLEDStripSettings:mn,get maxIntensity(){return Ae},get mirrored(){return Ve},get pulseSpeed(){return $e},get pulseWidth(){return be},setBaseIntensity:pn,setColorPalette:wn,setLEDColor:yn,setLEDIntensity:bn,setMaxIntensity:hn,setMirrored:vn,setPulseSpeed:fn,setPulseWidth:gn,setRimVisible:Tt,updateLEDAnimation:Rt},Symbol.toStringTag,{value:"Module"}));let It=null,ve=[],j=[],te=null,zt=[];function Be(){const e=new ft,n=new Ot;n.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/libs/draco/gltf/"),e.setDRACOLoader(n);const o=document.getElementById("loading");e.load("assets/models/wisdome.glb",t=>{if(console.log("Wisdome GLB loaded successfully"),!t||!t.scene){console.error("GLB loaded but scene is missing"),o.innerHTML='<div style="color: #ff4444;">Error: Model scene is missing.</div>';return}const i=t.scene;It=i,i.scale.setScalar(1),i.position.set(0,0,0),vt(i),te=new r.Group,te.name="GLBLights";const s=()=>{N(i,a=>{a.isLight&&(j.push(a),te.add(a),console.log("Found GLB light:",a.name||"Unnamed",a.type,"intensity:",a.intensity))})};"requestIdleCallback"in window?requestIdleCallback(s,{timeout:100}):s(),j.length===0&&(console.log("No lights found with isLight, checking object for light instances..."),N(i,a=>{(a instanceof r.Light||a instanceof r.DirectionalLight||a instanceof r.PointLight||a instanceof r.SpotLight||a instanceof r.RectAreaLight||a instanceof r.HemisphereLight)&&(j.includes(a)||(j.push(a),te.add(a),console.log("Found additional light:",a.name||"Unnamed",a.constructor.name)))})),j.length>0?(G.add(te),console.log(`Grouped ${j.length} lights from GLB`),window.savedLightSettings&&j.forEach((a,m)=>{const f=a.name||`light_${m}`,u=window.savedLightSettings[f];if(u){a.color.setRGB(u.r,u.g,u.b);const w=Math.max(0,Math.min(u.intensity??a.intensity,10));a.intensity=w}})):console.log("No lights found in GLB file. Lights GUI will not be available."),N(i,a=>{a.name==="Hotspots"&&N(a,m=>{if(m.name==="Hotspot.001"||m.name.includes("Hotspot")){const f=new r.Vector3;m.getWorldPosition(f),zt.push({object:m,position:f,name:m.name,triggered:!1}),console.log(`Found hotspot: ${m.name} at position:`,f)}})});const c=Ct(i);c?(console.log("Found LED_Rim object, creating LED strip..."),wt(()=>Promise.resolve().then(()=>Mn),void 0).then(a=>{a.loadLEDStripSettings()}),kt(c)):console.log("LED_Rim object not found in model"),N(i,a=>{if(a.isMesh){const m=a.name.toLowerCase();if(m.includes("led_rim")||m.includes("led_strip")||m.startsWith("led_"))return;if(m.includes("screen")||m.includes("display")||m.includes("monitor")||m.includes("panel")||m.includes("projection")||m.includes("canvas"))nt(a),a.visible=!0;else{let f=re(a);const u=f?.color?f.color.clone():new r.Color(16777215);if(f){if(f.metalness!==void 0&&(f.metalness=Math.max(f.metalness||0,.1)),f.roughness!==void 0&&(f.roughness=Math.min(f.roughness||.5,.8)),f.map&&(f.map.colorSpace=r.SRGBColorSpace),f.isMeshBasicMaterial){const w=new r.MeshStandardMaterial({color:f.color,map:f.map,transparent:f.transparent,opacity:f.opacity,metalness:.1,roughness:.5});a.material=w,f=w}f.needsUpdate=!0}ve.push({mesh:a,name:a.name||"Unnamed",originalColor:u})}}});let l=!1;N(i,a=>{a.isMesh&&a.name&&(a.name.toLowerCase().includes("screen")||a.name.toLowerCase().includes("display")||a.name.toLowerCase().includes("monitor")||a.name.toLowerCase().includes("panel")||a.name.toLowerCase().includes("projection")||a.name.toLowerCase().includes("canvas"))&&(l=!0)}),!l&&i&&i.children.length>0&&N(i,a=>{a.isMesh&&!l&&(nt(a),a.visible=!0,ve=ve.filter(m=>m.mesh!==a),l=!0)}),G.add(i),setTimeout(()=>{o.classList.add("hidden");const a=document.getElementById("canvas-container"),m=document.getElementById("info-panel");a&&a.classList.add("loaded"),m&&m.classList.add("loaded")},300);const g=ze||{x:0,y:5.4,z:-4.3},h=De||{x:-3,y:0,z:3.121154018741333};d.position.set(g.x,g.y,g.z),d.rotation.set(h.x,h.y,h.z),d.updateMatrixWorld(),C.setFromQuaternion(d.quaternion),Cn(!0),ln()&&Pt(),un(),sn(),rn()},void 0,t=>{console.error("Error loading 3D model:",t),o.innerHTML='<div style="color: #ff4444;">Error loading 3D model.</div>'})}const xn=Object.freeze(Object.defineProperty({__proto__:null,get fbxMeshes(){return ve},glbLights:j,get glbLightsGroup(){return te},hotspots:zt,loadModel:Be,get wisdomeModel(){return It}},Symbol.toStringTag,{value:"Module"}));let pe=null,E={forward:!1,backward:!1,left:!1,right:!1};function Dt(e){pe=e}function Pn(){if(!H)return;d.updateMatrixWorld();const e=new r.Vector3;e.setFromMatrixColumn(d.matrixWorld,2),e.multiplyScalar(-1).normalize();const n=new r.Vector3;n.setFromMatrixColumn(d.matrixWorld,0),n.normalize();const o=new r.Vector3,t=Ye;oe.w&&o.add(e.clone().multiplyScalar(t)),oe.s&&o.add(e.clone().multiplyScalar(-t)),oe.a&&o.add(n.clone().multiplyScalar(-t)),oe.d&&o.add(n.clone().multiplyScalar(t));const i=t*2;if(E.forward&&o.add(e.clone().multiplyScalar(i)),E.backward&&o.add(e.clone().multiplyScalar(-i)),E.left&&o.add(n.clone().multiplyScalar(-i)),E.right&&o.add(n.clone().multiplyScalar(i)),o.length()!==0)if(pe){const s=d.position.clone();s.x+=o.x,s.z+=o.z;const c={x:s.x,y:s.y-_,z:s.z},l=pe.findClosestPoint(c,{halfExtents:Pe});if(l.success)d.position.set(l.point.x,l.point.y+_,l.point.z);else{const g=pe.findClosestPoint({x:s.x,y:d.position.y-_,z:d.position.z},{halfExtents:Pe});if(g.success)d.position.set(g.point.x,g.point.y+_,d.position.z);else{const h=pe.findClosestPoint({x:d.position.x,y:d.position.y-_,z:s.z},{halfExtents:Pe});h.success&&d.position.set(d.position.x,h.point.y+_,h.point.z)}}}else d.position.add(o)}let Me=!1,C=new r.Euler(-3,0,3.121154018741333,"YXZ"),H=!1,je=0,Ne=0,oe={};function Cn(e){H=e}function ot(){function e(){const t=Me;Me=document.pointerLockElement===v||document.mozPointerLockElement===v||document.webkitPointerLockElement===v,!t&&Me&&H&&C.setFromQuaternion(d.quaternion)}document.addEventListener("pointerlockchange",e),document.addEventListener("mozpointerlockchange",e),document.addEventListener("webkitpointerlockchange",e);function n(t){if(!Me||!H)return;const i=t.movementX||t.mozMovementX||t.webkitMovementX||0,s=t.movementY||t.mozMovementY||t.webkitMovementY||0;C.y-=i*ne.sensitivity,C.x-=s*ne.sensitivity,C.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,C.x)),d.quaternion.setFromEuler(C)}v.addEventListener("mousemove",n);let o=null;v.addEventListener("touchstart",t=>{if(!(!document.body.classList.contains("dome-mode")||!H)){if(t.preventDefault(),t.touches.length===1&&o===null){const i=t.touches[0];o=i.identifier,je=i.clientX,Ne=i.clientY,C.setFromQuaternion(d.quaternion)}t.touches.length===2&&(E.forward=!0)}},{passive:!1}),v.addEventListener("touchmove",t=>{if(!(!document.body.classList.contains("dome-mode")||!H)){if(t.preventDefault(),o!==null){const i=Array.from(t.touches).find(s=>s.identifier===o);if(i){const s=i.clientX-je,c=i.clientY-Ne;C.y-=s*ne.sensitivity,C.x-=c*ne.sensitivity,C.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,C.x)),d.quaternion.setFromEuler(C),je=i.clientX,Ne=i.clientY}}t.touches.length===2?(E.forward=!0,E.backward=!1,E.left=!1,E.right=!1):t.touches.length===1&&(E.forward=!1)}},{passive:!1}),v.addEventListener("touchend",t=>{if(document.body.classList.contains("dome-mode")){t.preventDefault();for(let i=0;i<t.changedTouches.length;i++)t.changedTouches[i].identifier===o&&(o=null);t.touches.length<2&&(E.forward=!1,E.backward=!1,E.left=!1,E.right=!1)}},{passive:!1}),v.addEventListener("touchcancel",t=>{if(document.body.classList.contains("dome-mode")){t.preventDefault();for(let i=0;i<t.changedTouches.length;i++)t.changedTouches[i].identifier===o&&(o=null);E.forward=!1,E.backward=!1,E.left=!1,E.right=!1}},{passive:!1}),window.addEventListener("keydown",t=>{oe[t.key.toLowerCase()]=!0,(t.key==="c"||t.key==="C")&&(console.log("Camera Position:",d.position),console.log("Camera Rotation:",d.rotation))}),window.addEventListener("keyup",t=>{oe[t.key.toLowerCase()]=!1,t.key==="q"||t.key==="Q"||t.key==="e"||t.key})}function $t(){return window.visualViewport&&window.visualViewport.height?window.visualViewport.height:document.documentElement.clientHeight||window.innerHeight}function it(){const e=$t();document.documentElement.style.setProperty("--actual-vh",`${e}px`)}function Qe(){const e=getComputedStyle(document.documentElement),n=e.getPropertyValue("--row-height"),o=parseFloat(n);if(!isNaN(o)&&o>0)return o;const t=parseFloat(e.getPropertyValue("--grid-rows"))||16;return $t()/t}let ye=!1,st=0;const kn=50;let at=0,Oe=0,Y=0;function At(e){const n=Qe();return Math.round(e/n)*n}function He(){if(ye)return;const e=window.pageYOffset||document.documentElement.scrollTop,n=At(e);Math.abs(e-n)>1&&(ye=!0,window.scrollTo({top:n,behavior:"auto"}),setTimeout(()=>{ye=!1},50))}function Rn(){if(ye)return;const e=window.pageYOffset||document.documentElement.scrollTop,n=At(e),t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?5:1;Math.abs(e-n)>t&&He()}function Vt(e){const n=Date.now();if(n-st<kn)return;const o=Qe(),t=window.pageYOffset||document.documentElement.scrollTop;if(e!==0){const c=(Math.round(t/o)+e)*o,l=Math.max(document.body.scrollHeight-window.innerHeight,document.documentElement.scrollHeight-window.innerHeight),g=Math.max(0,Math.min(c,l));Math.abs(g-t)>1&&(st=n,window.scrollTo({top:g,behavior:"auto"}))}}function Tn(e){if(document.body.classList.contains("dome-mode"))return;e.preventDefault();const n=e.deltaY;let o=0;n>0?o=1:n<0&&(o=-1),o!==0&&Vt(o)}function In(e){document.body.classList.contains("dome-mode")||e.touches.length===1&&(at=e.touches[0].clientY,Oe=at,Y=0)}function zn(e){if(document.body.classList.contains("dome-mode")||e.touches.length!==1)return;e.preventDefault();const n=e.touches[0].clientY,o=Oe-n;Y+=o,Oe=n;const i=Qe()*.3;if(Math.abs(Y)>=i){const s=Y>0?1:-1;Vt(s),Y=Y%i}}function Dn(e){document.body.classList.contains("dome-mode")||(e.preventDefault(),Y=0)}function $n(){if(!qe.enabled||document.body.classList.contains("dome-mode"))return;window.addEventListener("wheel",Tn,{passive:!1}),document.addEventListener("touchstart",In,{passive:!1}),document.addEventListener("touchmove",zn,{passive:!1}),document.addEventListener("touchend",Dn,{passive:!1});let e=null;window.addEventListener("scroll",()=>{if(ye)return;e&&clearTimeout(e),e=setTimeout(()=>{Rn(),e=null},50)},{passive:!0}),window.addEventListener("load",()=>{setTimeout(()=>{He()},100)}),window.addEventListener("resize",()=>{setTimeout(()=>{He()},100)})}let se=null,rt=16;function An(){const e=document.getElementById("dots");e&&e.remove(),se=document.createElement("div"),se.id="dots",document.body.appendChild(se),Ge(),Ue()}function Ge(){const e=getComputedStyle(document.documentElement);document.documentElement.clientWidth||window.innerWidth,e.getPropertyValue("--col-width"),e.getPropertyValue("--row-height")}function Ue(){if(!se)return;se.innerHTML="";const e=16;for(let n=0;n<e;n++)for(let o=0;o<rt;o++){const t=document.createElement("div");t.className="dot",t.dataset.col=o+1,t.dataset.row=n+1,t.style.gridColumn=o+1,t.style.gridRow=n+1,t.style.pointerEvents="none";const i=o+1,s=n+1,c=i+(s-1)*rt;t.style.setProperty("--dot-delay",c),se.appendChild(t)}}function Vn(){An();let e;const n=()=>{clearTimeout(e),e=setTimeout(()=>{Ge(),Ue()},150)};window.addEventListener("resize",n),window.addEventListener("orientationchange",()=>{setTimeout(()=>{Ge(),Ue()},300)})}function lt(e){document.querySelectorAll(".dashboard-block.active, .page-content .block.active").forEach(n=>{n.classList.remove("active")}),e.classList.add("active")}function Fn(){document.querySelectorAll(".dashboard-block").forEach(o=>{o.addEventListener("click",()=>{lt(o)})}),document.querySelectorAll(".page-content .block img").forEach(o=>{const t=o.closest(".block");t&&t.addEventListener("click",()=>{lt(t)})})}function _e(){document.querySelectorAll(".page-content.responsive").forEach(n=>{const o=n.closest(".page-section");o&&(o.style.height="",o.style.minHeight="")})}function Wn(){_e();let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{_e()},100)}),window.addEventListener("load",()=>{_e()})}let Re=0,ct=0;const jn=2e3;function Nn(){const e=document.querySelector("main");if(!e)return;const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),o=[];let t;for(;t=n.nextNode();)t.parentElement?.classList.contains("dome-dreaming-text")||/dome\s+dreaming/i.test(t.textContent)&&o.push(t);o.forEach(i=>{const s=i.parentNode;if(!s)return;const c=i.textContent,l=/(dome\s+dreaming)/gi,g=c.split(l),h=document.createDocumentFragment();g.forEach(L=>{if(L&&/^dome\s+dreaming$/i.test(L)){const a=document.createElement("span");a.className="dome-dreaming-text",a.textContent=L,h.appendChild(a)}else L&&h.appendChild(document.createTextNode(L))}),s.replaceChild(h,i)})}async function dt(){await Kt(),it(),$n(),Vn(),Wn(),Fn(),Nn(),"requestIdleCallback"in window?requestIdleCallback(()=>{Je(),tt(),ot()},{timeout:1e3}):setTimeout(()=>{Je(),tt(),ot(),initParallaxLayer()},50);const e=document.getElementById("connect-webcam-link");e&&e.addEventListener("click",t=>{t.preventDefault(),an()});const n=document.getElementById("upload-file-link");if(n){const t=document.createElement("input");t.type="file",t.accept="image/*,video/*",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",i=>{const s=i.target.files?.[0];s&&(s.type.startsWith("image/")?St(s):s.type.startsWith("video/")&&Mt(s)),t.value=""}),n.addEventListener("click",i=>{i.preventDefault(),t.click()})}const o=()=>{it()};window.addEventListener("resize",o),window.visualViewport&&window.visualViewport.addEventListener("resize",o),window.addEventListener("orientationchange",()=>{setTimeout(o,100)}),"requestIdleCallback"in window?requestIdleCallback(()=>{Be(),ut()},{timeout:2e3}):requestAnimationFrame(()=>{setTimeout(()=>{Be(),ut()},100)})}function Ft(e){requestAnimationFrame(Ft);const n=(e-Re)/1e3;Re=e,Pn(),Le.x=d.position.x,Le.y=d.position.y,Le.z=d.position.z,Ee.x=d.rotation.x,Ee.y=d.rotation.y,Ee.z=d.rotation.z,e-ct>=jn&&(Object.assign(ze,Le),Object.assign(De,Ee),Et(ve,j),ct=e),Rt(n),_n(n),en()}function _n(e){if(!Q.enabled)return;const n=on(),o=nn(),t=n||o;if(t)for((!t.center||t.center.x!==.5||t.center.y!==.5)&&(t.center?t.center.set(.5,.5):t.center=new THREE.Vector2(.5,.5)),t.rotation-=Q.speed*e;t.rotation<0;)t.rotation+=Math.PI*2}function ut(){Re=performance.now(),Ft(Re)}function mt(){const e=document.getElementById("enter-dome-btn"),n=document.body;function o(s=!1){if(n.classList.contains("dome-mode"))return;n.classList.add("dome-mode"),document.documentElement.style.overflow="hidden";const c=document.getElementById("canvas-container");if(c){const g=getComputedStyle(document.documentElement).getPropertyValue("--actual-vh");c.style.height=g||"100vh",c.style.width="100vw",setTimeout(()=>{window.dispatchEvent(new Event("resize"))},0)}const l=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0;s&&v&&!l&&setTimeout(()=>{const g=v.requestPointerLock||v.mozRequestPointerLock||v.webkitRequestPointerLock;g&&g.call(v)},100)}function t(){if(v&&(document.pointerLockElement===v||document.mozPointerLockElement===v||document.webkitPointerLockElement===v)&&document.exitPointerLock(),n.classList.contains("dome-mode")){n.classList.remove("dome-mode"),document.documentElement.style.overflow="auto";const s=document.getElementById("canvas-container");s&&(s.style.width="")}}window.enterDomeModeFromCanvas=()=>{o(!0)},e&&v&&(e.addEventListener("click",s=>{s.stopPropagation(),o(!0)}),e.addEventListener("touchend",s=>{s.stopPropagation(),s.preventDefault(),o(!0)})),document.addEventListener("keydown",s=>{s.key==="Escape"&&n.classList.contains("dome-mode")&&(!v||document.pointerLockElement!==v&&document.mozPointerLockElement!==v&&document.webkitPointerLockElement!==v?t():document.exitPointerLock())});function i(){const s=v&&(document.pointerLockElement===v||document.mozPointerLockElement===v||document.webkitPointerLockElement===v),c=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0;!s&&n.classList.contains("dome-mode")&&!c&&t()}document.addEventListener("pointerlockchange",i),document.addEventListener("mozpointerlockchange",i),document.addEventListener("webkitpointerlockchange",i)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{dt(),mt()}):(dt(),mt());
