import*as THREE from"three";import{getMaterial}from"../3d/utils.js";export let constants={cameraHeight:1.6,navmeshSearchBox:{x:5,y:10,z:5},screenMaterialSettings:{emissive:[1,1,1],emissiveIntensity:1,color:[1,1,1],toneMapped:!1,transparent:!1,opacity:1}};export let moveSpeed=.04;export let cameraSettings={sensitivity:.002,rotationSpeed:120};export let startCameraPosition={x:0,y:5.4,z:-4.3};export let startCameraRotation={x:-2.8,y:0,z:3.121154018741333};export let currentCameraPosition={x:0,y:0,z:0};export let currentCameraRotation={x:0,y:0,z:0};export let bloomSettings={enabled:!0,strength:1.5,radius:.4,threshold:.85};export let dofSettings={enabled:!0,focus:12,aperture:.0014,maxblur:.05};export let pageColorSettings={backgroundColor:"#000000",textColor:"#ffffff",dotColor:"#ffffff",sidebarColor:"#333333",sidebarVisible:!0,headerIslandVisible:!1,blendMode:"normal",vignette:{enabled:!1,size:8,fadeWidth:2}};export let scrollSettings={enabled:!0,scrollTimeout:25,touchThreshold:30,snapThreshold:.5,initialSnapThreshold:1,gridColumns:16,gridRows:16};export let canvasSettings={rows:8};export let screenSettings={defaultImage:"assets/img/jpg/background-dome-dreaming.jpg"};export let textureRotationSettings={enabled:!0,speed:.02};export let pageBackgroundSettings={canvas:{backgroundColor:"#000000",backgroundImage:null},about:{backgroundColor:"#463434",backgroundImage:null},team:{backgroundColor:"#000000",backgroundImage:null}};export function setMoveSpeed(t){moveSpeed=t}export function setBloomSettings(t,e,o){bloomSettings.strength=t,bloomSettings.radius=e,bloomSettings.threshold=o}async function loadDefaultSettings(t=!1){try{const e="assets/js/core/default-settings.json",o=t?`${e}?t=${Date.now()}`:e,n=await fetch(o);if(!n.ok)return!1;const r=await n.json();return r.constants&&(constants={...constants,...r.constants}),r.settings&&applySettings(r.settings),!0}catch(t){return!1}}function applySettings(t){void 0!==t.moveSpeed&&(moveSpeed=t.moveSpeed),t.cameraSettings&&Object.assign(cameraSettings,t.cameraSettings),t.startCameraPosition&&Object.assign(startCameraPosition,t.startCameraPosition),t.startCameraRotation&&Object.assign(startCameraRotation,t.startCameraRotation),t.colorSettings?window.savedColorSettings=t.colorSettings:window.savedColorSettings=null,t.lightSettings?window.savedLightSettings=t.lightSettings:window.savedLightSettings=null,t.bloomSettings&&Object.assign(bloomSettings,t.bloomSettings),t.dofSettings&&Object.assign(dofSettings,t.dofSettings),t.pageColorSettings&&(t.pageColorSettings.vignette&&(pageColorSettings.vignette={...pageColorSettings.vignette,...t.pageColorSettings.vignette}),Object.assign(pageColorSettings,t.pageColorSettings),pageColorSettings.vignette||(pageColorSettings.vignette={enabled:!0,size:8,fadeWidth:2}),applyPageColors()),t.scrollSettings&&Object.assign(scrollSettings,t.scrollSettings),t.canvasSettings&&Object.assign(canvasSettings,t.canvasSettings),t.screenSettings&&Object.assign(screenSettings,t.screenSettings),t.textureRotationSettings&&Object.assign(textureRotationSettings,t.textureRotationSettings),t.pageBackgroundSettings&&(Object.assign(pageBackgroundSettings,t.pageBackgroundSettings),applyPageBackgrounds())}function hexToRgba(t,e=.5){if(!t)return null;if(t.startsWith("rgba"))return t;if(t.startsWith("rgb")){const o=t.match(/\d+/g);if(o&&o.length>=3)return`rgba(${o[0]}, ${o[1]}, ${o[2]}, ${e})`}const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return o?`rgba(${parseInt(o[1],16)}, ${parseInt(o[2],16)}, ${parseInt(o[3],16)}, ${e})`:t}export function applyPageBackgrounds(){"requestIdleCallback"in window?requestIdleCallback(()=>{const t=document.querySelectorAll(".page-section");if(t.length>0&&t.length>1&&pageBackgroundSettings.team)for(let e=1;e<t.length;e++){const o=t[e];if(pageBackgroundSettings.team.backgroundColor&&"#000000"!==pageBackgroundSettings.team.backgroundColor){const t=hexToRgba(pageBackgroundSettings.team.backgroundColor,.5);o.style.setProperty("background-color",t,"important")}else o.style.removeProperty("background-color");pageBackgroundSettings.team.backgroundImage?(o.style.setProperty("background-image",`url(${pageBackgroundSettings.team.backgroundImage})`,"important"),o.style.setProperty("background-size","cover","important"),o.style.setProperty("background-position","center","important"),o.style.setProperty("background-repeat","no-repeat","important")):o.style.removeProperty("background-image")}},{timeout:200}):setTimeout(()=>{const t=document.querySelectorAll(".page-section");if(t.length>0&&t.length>1&&pageBackgroundSettings.team)for(let e=1;e<t.length;e++){const o=t[e];if(pageBackgroundSettings.team.backgroundColor&&"#000000"!==pageBackgroundSettings.team.backgroundColor){const t=hexToRgba(pageBackgroundSettings.team.backgroundColor,.5);o.style.setProperty("background-color",t,"important")}else o.style.removeProperty("background-color");pageBackgroundSettings.team.backgroundImage?(o.style.setProperty("background-image",`url(${pageBackgroundSettings.team.backgroundImage})`,"important"),o.style.setProperty("background-size","cover","important"),o.style.setProperty("background-position","center","important"),o.style.setProperty("background-repeat","no-repeat","important")):o.style.removeProperty("background-image")}},50)}function applyVignette(){const t=document.getElementById("canvas-container");if(!t)return;const e=pageColorSettings.vignette||{enabled:!0,size:8,fadeWidth:2};if(!e.enabled)return t.style.maskImage="none",void(t.style.webkitMaskImage="none");const o=`${e.size}%`,n=`${e.size+e.fadeWidth}%`,r=`${e.size+2*e.fadeWidth}%`,a=100-e.size-2*e.fadeWidth+"%",s=100-e.size-e.fadeWidth+"%",i=100-e.size+"%",g=`linear-gradient(to right, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${n}, black ${r}, black ${a}, rgba(0, 0, 0, 0.5) ${s}, transparent ${i}, transparent 100%)`,l=`linear-gradient(to bottom, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${n}, black ${r}, black ${a}, rgba(0, 0, 0, 0.5) ${s}, transparent ${i}, transparent 100%)`;t.style.maskImage=`${g}, ${l}`,t.style.maskComposite="intersect",t.style.webkitMaskImage=`${g}, ${l}`,t.style.webkitMaskComposite="source-in"}export function applyPageColors(){applyVignette()}export function applyVignetteSettings(){applyVignette()}export async function loadSettings(t=!1){await loadDefaultSettings(t),applyPageColors(),applyPageBackgrounds()}const DEFAULT_COLORS={primary:{r:.4,g:.45,b:.5},secondary:{r:.55,g:.32,b:.38},tertiary:{r:.65,g:.52,b:.25}},MESH_COLOR_MAP={Main_Structure:"primary",Chairs:"secondary",Floor:"tertiary"};let generatedColors={primary:null,secondary:null,tertiary:null};export function getRandomGeneratedColor(){const t=Object.values(generatedColors).filter(t=>null!==t);return 0===t.length?DEFAULT_COLORS.primary:t[Math.floor(Math.random()*t.length)]}let useDefaultColors=!0;const MAIN_COLORS=[{r:.38,g:.42,b:.48},{r:.45,g:.48,b:.52},{r:.42,g:.45,b:.5},{r:.48,g:.45,b:.42}],VIBRANT_COLORS=[{r:.55,g:.32,b:.38},{r:.65,g:.52,b:.25},{r:.45,g:.55,b:.42},{r:.6,g:.4,b:.32},{r:.4,g:.5,b:.58},{r:.48,g:.3,b:.45}];function generateMainColor(){const t=Math.floor(Math.random()*MAIN_COLORS.length);return MAIN_COLORS[t]}function generateVibrantColor(){const t=Math.floor(Math.random()*VIBRANT_COLORS.length);return VIBRANT_COLORS[t]}function generateRandomMutedColor(){return generateVibrantColor()}function darkenForCSS(t,e=.4){return{r:t.r*e,g:t.g*e,b:t.b*e}}function applyBackgroundColors(){const t=t=>`rgb(${Math.round(255*t.r)}, ${Math.round(255*t.g)}, ${Math.round(255*t.b)})`;import("../3d/model.js").then(e=>{let o=null,n=null,r=null;if(e.fbxMeshes&&e.fbxMeshes.length>0){const t=e.fbxMeshes.find(t=>"Main_Structure"===t.name);if(t){const e=getMaterial(t.mesh);e&&e.color&&(o={r:e.color.r,g:e.color.g,b:e.color.b})}const a=e.fbxMeshes.find(t=>"Chairs"===t.name);if(a){const t=getMaterial(a.mesh);t&&t.color&&(n={r:t.color.r,g:t.color.g,b:t.color.b})}const s=e.fbxMeshes.find(t=>"Floor"===t.name);if(s){const t=getMaterial(s.mesh);t&&t.color&&(r={r:t.color.r,g:t.color.g,b:t.color.b})}}o||(o=window.savedColorSettings?.primary||window.savedColorSettings?.Main_Structure||generateRandomMutedColor()),n||(n=window.savedColorSettings?.secondary||window.savedColorSettings?.Chairs||generateRandomMutedColor()),r||(r=window.savedColorSettings?.tertiary||window.savedColorSettings?.Floor||generateRandomMutedColor()),generatedColors.primary=o,generatedColors.secondary=n,generatedColors.tertiary=r;const a=o,s=darkenForCSS(n,.6),i=darkenForCSS(r,.6);useDefaultColors||(document.documentElement.style.setProperty("--color-primary",t(o)),document.documentElement.style.setProperty("--color-secondary",t(n)),document.documentElement.style.setProperty("--color-tertiary",t(r)),document.documentElement.style.setProperty("--bg-main-color",t(a)),document.documentElement.style.setProperty("--bg-floor-color",t(i)),document.documentElement.style.setProperty("--bg-chairs-color",t(s))),import("../3d/scene.js").then(t=>{t.setSceneBackground(a)})})}export async function applySettingsToScene(){window.savedColorSettings||(window.savedColorSettings={}),import("../3d/model.js").then(t=>{if(t.fbxMeshes&&t.fbxMeshes.length>0){let e=0;const o=5;!function n(){const r=Math.min(e+o,t.fbxMeshes.length);for(let o=e;o<r;o++){const e=t.fbxMeshes[o],n=getMaterial(e.mesh);if(n){let t;e.name,"Main_Structure"===e.name?(t=useDefaultColors?DEFAULT_COLORS.primary:generateMainColor(),window.savedColorSettings.primary=t,window.savedColorSettings[e.name]=t):"Chairs"===e.name?(t=useDefaultColors?DEFAULT_COLORS.secondary:generateVibrantColor(),window.savedColorSettings.secondary=t,window.savedColorSettings[e.name]=t):"Floor"===e.name?(t=useDefaultColors?DEFAULT_COLORS.tertiary:generateVibrantColor(),window.savedColorSettings.tertiary=t,window.savedColorSettings[e.name]=t):"Screen"===e.name?(t=generateVibrantColor(),window.savedColorSettings[e.name]=t):t=window.savedColorSettings[e.name]?window.savedColorSettings[e.name]:e.originalColor?{r:e.originalColor.r,g:e.originalColor.g,b:e.originalColor.b}:null,t&&(n.color.setRGB(t.r,t.g,t.b),n.needsUpdate=!0)}}e=r,e<t.fbxMeshes.length?"requestIdleCallback"in window?requestIdleCallback(n,{timeout:50}):setTimeout(n,0):setTimeout(()=>{applyBackgroundColors()},10)}()}window.savedLightSettings&&t.glbLights&&("requestIdleCallback"in window?requestIdleCallback(()=>{t.glbLights.forEach((t,e)=>{const o=t.name||`light_${e}`;if(window.savedLightSettings[o]){const e=window.savedLightSettings[o];t.color.setRGB(e.r,e.g,e.b);const n=Math.max(0,Math.min(e.intensity??t.intensity,10));t.intensity=n}})},{timeout:100}):setTimeout(()=>{t.glbLights.forEach((t,e)=>{const o=t.name||`light_${e}`;if(window.savedLightSettings[o]){const e=window.savedLightSettings[o];t.color.setRGB(e.r,e.g,e.b);const n=Math.max(0,Math.min(e.intensity??t.intensity,10));t.intensity=n}})},50))}),import("../3d/postprocessing.js").then(t=>{const e=t.getBloomPass();e&&(e.enabled=!1!==bloomSettings.enabled,bloomSettings.enabled?(e.strength=bloomSettings.strength,e.radius=bloomSettings.radius,e.threshold=bloomSettings.threshold):e.strength=0);const o=t.getBokehPass();o&&(o.enabled=!1!==dofSettings.enabled,dofSettings.enabled&&(o.uniforms.focus.value=dofSettings.focus,o.uniforms.aperture.value=dofSettings.aperture,o.uniforms.maxblur.value=dofSettings.maxblur))})}export async function reloadFromJSON(){await loadSettings(!0),await applySettingsToScene()}export async function randomizeColors(){useDefaultColors=!1,await applySettingsToScene()}export async function resetToDefaultColors(){useDefaultColors=!0,await applySettingsToScene()}export function saveSettings(t,e){try{const o={};t&&Array.isArray(t)&&t.forEach((t,e)=>{const n=getMaterial(t.mesh);if(n?.color){const r=t.name||`mesh_${e}`;o[r]={r:n.color.r,g:n.color.g,b:n.color.b}}});const n={};e&&Array.isArray(e)&&e.forEach((t,e)=>{const o=t.name||`light_${e}`;n[o]={r:t.color.r,g:t.color.g,b:t.color.b,intensity:t.intensity}})}catch(t){}}export function exportSettingsFile(t,e){try{const o={};t.forEach((t,e)=>{const n=getMaterial(t.mesh);if(n?.color){const r=t.name||`mesh_${e}`;o[r]={r:n.color.r,g:n.color.g,b:n.color.b}}});const n={};e.forEach((t,e)=>{const o=t.name||`light_${e}`;n[o]={r:t.color.r,g:t.color.g,b:t.color.b,intensity:t.intensity}});const r={version:"1.0.0",constants:constants,settings:{moveSpeed:moveSpeed,pageColorSettings:pageColorSettings,scrollSettings:scrollSettings,canvasSettings:canvasSettings,cameraSettings:cameraSettings,startCameraPosition:startCameraPosition,startCameraRotation:startCameraRotation,bloomSettings:bloomSettings,dofSettings:dofSettings,colorSettings:o,lightSettings:n,screenSettings:screenSettings,textureRotationSettings:textureRotationSettings,pageBackgroundSettings:pageBackgroundSettings}},a=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download="dome-dreaming-settings.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}catch(t){}}