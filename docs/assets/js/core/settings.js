import*as THREE from"three";import{getMaterial}from"../3d/utils.js";export let constants={cameraHeight:1.6,navmeshSearchBox:{x:5,y:10,z:5},screenMaterialSettings:{emissive:[1,1,1],emissiveIntensity:1,color:[1,1,1],toneMapped:!1,transparent:!1,opacity:1}};export let moveSpeed=.04;export let cameraSettings={sensitivity:.002,rotationSpeed:120};export let startCameraPosition={x:0,y:5.4,z:-4.3};export let startCameraRotation={x:-3,y:0,z:3.121154018741333};export let currentCameraPosition={x:0,y:0,z:0};export let currentCameraRotation={x:0,y:0,z:0};export let bloomSettings={enabled:!0,strength:1.5,radius:.4,threshold:.85};export let pageColorSettings={backgroundColor:"#000000",textColor:"#ffffff",dotColor:"#ffffff",sidebarColor:"#333333",sidebarVisible:!0,headerIslandVisible:!1,blendMode:"normal",vignette:{enabled:!1,size:8,fadeWidth:2}};export let scrollSettings={enabled:!0,scrollTimeout:25,touchThreshold:30,snapThreshold:.5,initialSnapThreshold:1,gridColumns:16,gridRows:16};export let canvasSettings={rows:8};export let screenSettings={defaultImage:"assets/img/background.png"};export let textureRotationSettings={enabled:!0,speed:.02};export let pageBackgroundSettings={canvas:{backgroundColor:"#000000",backgroundImage:null},about:{backgroundColor:"#463434",backgroundImage:null},team:{backgroundColor:"#000000",backgroundImage:null}};export function setMoveSpeed(t){moveSpeed=t}export function setBloomSettings(t,e,o){bloomSettings.strength=t,bloomSettings.radius=e,bloomSettings.threshold=o}async function loadDefaultSettings(t=!1){try{const e="assets/js/core/default-settings.json",o=t?`${e}?t=${Date.now()}`:e,n=await fetch(o);if(!n.ok)return!1;const a=await n.json();return a.constants&&(constants={...constants,...a.constants}),a.settings&&applySettings(a.settings),!0}catch(t){return!1}}function applySettings(t){void 0!==t.moveSpeed&&(moveSpeed=t.moveSpeed),t.cameraSettings&&Object.assign(cameraSettings,t.cameraSettings),t.startCameraPosition&&Object.assign(startCameraPosition,t.startCameraPosition),t.startCameraRotation&&Object.assign(startCameraRotation,t.startCameraRotation),t.colorSettings?window.savedColorSettings=t.colorSettings:window.savedColorSettings=null,t.lightSettings?window.savedLightSettings=t.lightSettings:window.savedLightSettings=null,t.bloomSettings&&Object.assign(bloomSettings,t.bloomSettings),t.pageColorSettings&&(t.pageColorSettings.vignette&&(pageColorSettings.vignette={...pageColorSettings.vignette,...t.pageColorSettings.vignette}),Object.assign(pageColorSettings,t.pageColorSettings),pageColorSettings.vignette||(pageColorSettings.vignette={enabled:!0,size:8,fadeWidth:2}),applyPageColors()),t.scrollSettings&&Object.assign(scrollSettings,t.scrollSettings),t.canvasSettings&&Object.assign(canvasSettings,t.canvasSettings),t.screenSettings&&Object.assign(screenSettings,t.screenSettings),t.textureRotationSettings&&Object.assign(textureRotationSettings,t.textureRotationSettings),t.pageBackgroundSettings&&(Object.assign(pageBackgroundSettings,t.pageBackgroundSettings),applyPageBackgrounds())}function hexToRgba(t,e=.5){if(!t)return null;if(t.startsWith("rgba"))return t;if(t.startsWith("rgb")){const o=t.match(/\d+/g);if(o&&o.length>=3)return`rgba(${o[0]}, ${o[1]}, ${o[2]}, ${e})`}const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return o?`rgba(${parseInt(o[1],16)}, ${parseInt(o[2],16)}, ${parseInt(o[3],16)}, ${e})`:t}export function applyPageBackgrounds(){const t=document.querySelectorAll(".page-section");if(t.length>0&&t.length>1&&pageBackgroundSettings.team)for(let e=1;e<t.length;e++){const o=t[e];if(pageBackgroundSettings.team.backgroundColor&&"#000000"!==pageBackgroundSettings.team.backgroundColor){const t=hexToRgba(pageBackgroundSettings.team.backgroundColor,.5);o.style.setProperty("background-color",t,"important")}else o.style.removeProperty("background-color");pageBackgroundSettings.team.backgroundImage?(o.style.setProperty("background-image",`url(${pageBackgroundSettings.team.backgroundImage})`,"important"),o.style.setProperty("background-size","cover","important"),o.style.setProperty("background-position","center","important"),o.style.setProperty("background-repeat","no-repeat","important")):o.style.removeProperty("background-image")}}function applyVignette(){const t=document.getElementById("canvas-container");if(!t)return;const e=pageColorSettings.vignette||{enabled:!0,size:8,fadeWidth:2};if(!e.enabled)return t.style.maskImage="none",void(t.style.webkitMaskImage="none");const o=`${e.size}%`,n=`${e.size+e.fadeWidth}%`,a=`${e.size+2*e.fadeWidth}%`,r=100-e.size-2*e.fadeWidth+"%",s=100-e.size-e.fadeWidth+"%",i=100-e.size+"%",g=`linear-gradient(to right, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${n}, black ${a}, black ${r}, rgba(0, 0, 0, 0.5) ${s}, transparent ${i}, transparent 100%)`,l=`linear-gradient(to bottom, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${n}, black ${a}, black ${r}, rgba(0, 0, 0, 0.5) ${s}, transparent ${i}, transparent 100%)`;t.style.maskImage=`${g}, ${l}`,t.style.maskComposite="intersect",t.style.webkitMaskImage=`${g}, ${l}`,t.style.webkitMaskComposite="source-in"}export function applyPageColors(){applyVignette()}export function applyVignetteSettings(){applyVignette()}export async function loadSettings(t=!1){const e=await loadDefaultSettings(t);if(e||t)e&&applyPageColors();else try{const t=localStorage.getItem("domeDreamingSettings");if(!t)return void applyPageColors();applySettings(JSON.parse(t))}catch(t){applyPageColors()}applyPageBackgrounds()}function generateRandomMutedColor(){const t=Math.random(),e=.2+.2*Math.random(),o=.3+.2*Math.random(),n=new THREE.Color;return n.setHSL(t,e,o),{r:n.r,g:n.g,b:n.b}}function darkenColor(t,e=.5){return{r:t.r*e,g:t.g*e,b:t.b*e}}function muteColor(t,e=.3){const o=new THREE.Color(t.r,t.g,t.b),n={h:0,s:0,l:0};return o.getHSL(n),n.s=n.s*e,o.setHSL(n.h,n.s,n.l),{r:o.r,g:o.g,b:o.b}}function applyBackgroundColors(){window.savedColorSettings||(window.savedColorSettings={});const t={"bg-1":window.savedColorSettings.Main_Structure,"bg-2":window.savedColorSettings.Floor,"bg-3":window.savedColorSettings.Screen};t["bg-1"]||(t["bg-1"]=generateRandomMutedColor(),window.savedColorSettings.Main_Structure=t["bg-1"]),t["bg-2"]||(t["bg-2"]=generateRandomMutedColor(),window.savedColorSettings.Floor=t["bg-2"]),t["bg-3"]||(t["bg-3"]=generateRandomMutedColor(),window.savedColorSettings.Screen=t["bg-3"]),["bg-1","bg-2","bg-3"].forEach((e,o)=>{const n=["Main_Structure","Floor","Screen"][o],a=window.savedColorSettings[n]||t[e];window.savedColorSettings[n]||(window.savedColorSettings[n]=a);const r=muteColor(a,.3);window.savedColorSettings[e]=r;const s=Math.round(255*r.r),i=Math.round(255*r.g),g=Math.round(255*r.b);document.querySelectorAll(`.${e}`).forEach(t=>{t.style.backgroundColor=`rgb(${s}, ${i}, ${g})`})}),["bg-4","bg-5","bg-6"].forEach((t,e)=>{const o=["bg-1","bg-2","bg-3"][e],n=darkenColor(window.savedColorSettings[o],.5);window.savedColorSettings[t]=n;const a=Math.round(255*n.r),r=Math.round(255*n.g),s=Math.round(255*n.b);document.querySelectorAll(`.${t}`).forEach(t=>{t.style.backgroundColor=`rgb(${a}, ${r}, ${s})`})})}export async function applySettingsToScene(){window.savedColorSettings||(window.savedColorSettings={}),import("../3d/model.js").then(t=>{t.fbxMeshes&&t.fbxMeshes.length>0&&t.fbxMeshes.forEach(t=>{const e=getMaterial(t.mesh);if(e){let o;"Main_Structure"===t.name||"Floor"===t.name?(o=generateRandomMutedColor(),window.savedColorSettings[t.name]=o):o=window.savedColorSettings[t.name]?window.savedColorSettings[t.name]:t.originalColor?{r:t.originalColor.r,g:t.originalColor.g,b:t.originalColor.b}:null,o&&(e.color.setRGB(o.r,o.g,o.b),e.needsUpdate=!0)}}),applyBackgroundColors(),window.savedLightSettings&&t.glbLights&&t.glbLights.forEach((t,e)=>{const o=t.name||`light_${e}`;if(window.savedLightSettings[o]){const e=window.savedLightSettings[o];t.color.setRGB(e.r,e.g,e.b);const n=Math.max(0,Math.min(e.intensity??t.intensity,10));t.intensity=n}})}),import("../3d/postprocessing.js").then(t=>{const e=t.getBloomPass();e&&(e.enabled=!1!==bloomSettings.enabled,bloomSettings.enabled?(e.strength=bloomSettings.strength,e.radius=bloomSettings.radius,e.threshold=bloomSettings.threshold):e.strength=0)})}export async function reloadFromJSON(){await loadSettings(!0),await applySettingsToScene()}export function saveSettings(t,e){try{const o={};t&&Array.isArray(t)&&t.forEach((t,e)=>{const n=getMaterial(t.mesh);if(n?.color){const a=t.name||`mesh_${e}`;o[a]={r:n.color.r,g:n.color.g,b:n.color.b}}});const n={};e&&Array.isArray(e)&&e.forEach((t,e)=>{const o=t.name||`light_${e}`;n[o]={r:t.color.r,g:t.color.g,b:t.color.b,intensity:t.intensity}});const a={moveSpeed:moveSpeed,cameraSettings:cameraSettings,startCameraPosition:startCameraPosition,startCameraRotation:startCameraRotation,colorSettings:o,lightSettings:n,bloomSettings:bloomSettings,pageColorSettings:pageColorSettings,scrollSettings:scrollSettings,canvasSettings:canvasSettings,screenSettings:screenSettings,textureRotationSettings:textureRotationSettings,pageBackgroundSettings:pageBackgroundSettings};localStorage.setItem("domeDreamingSettings",JSON.stringify(a))}catch(t){}}export function exportSettingsFile(t,e){try{const o={};t.forEach((t,e)=>{const n=getMaterial(t.mesh);if(n?.color){const a=t.name||`mesh_${e}`;o[a]={r:n.color.r,g:n.color.g,b:n.color.b}}});const n={};e.forEach((t,e)=>{const o=t.name||`light_${e}`;n[o]={r:t.color.r,g:t.color.g,b:t.color.b,intensity:t.intensity}});const a={version:"1.0.0",constants:constants,settings:{moveSpeed:moveSpeed,pageColorSettings:pageColorSettings,scrollSettings:scrollSettings,canvasSettings:canvasSettings,cameraSettings:cameraSettings,startCameraPosition:startCameraPosition,startCameraRotation:startCameraRotation,bloomSettings:bloomSettings,colorSettings:o,lightSettings:n,screenSettings:screenSettings,textureRotationSettings:textureRotationSettings,pageBackgroundSettings:pageBackgroundSettings}},r=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s,i.download="dome-dreaming-settings.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}catch(t){}}