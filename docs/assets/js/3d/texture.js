import*as THREE from"three";import{configureTexture,applyTextureToScreen,getMaterial}from"./utils.js";import{SCREEN_MATERIAL_SETTINGS}from"./config.js";import{screenSettings,textureRotationSettings}from"../core/settings.js";let screenObject=null,currentVideoTexture=null,currentVideo=null,currentImageTexture=null,currentWebcamStream=null;export function setScreenObject(e){screenObject=e}export function getScreenObject(){return screenObject}export function getCurrentVideoTexture(){return currentVideoTexture}export function getCurrentVideo(){return currentVideo}export function getCurrentImageTexture(){return currentImageTexture}export function loadDefaultScreenTexture(e=screenSettings.defaultImage||"assets/media/background.png"){return screenObject?(currentImageTexture&&(currentImageTexture.dispose(),currentImageTexture=null),new Promise((r,t)=>{const n=new THREE.TextureLoader,c=e+(e.includes("?")?"&":"?")+"_t="+Date.now();n.load(c,e=>{configureTexture(e),e.rotation=0,applyTextureToScreen(e,screenObject),currentImageTexture=e,r(e)},void 0,e=>{t(e)})})):Promise.resolve()}export function loadImage(e){if(!screenObject)return;const r=new FileReader;r.onload=e=>{(new THREE.TextureLoader).load(e.target.result,e=>{currentVideoTexture&&(currentVideoTexture.dispose(),currentVideoTexture=null),currentVideo&&(currentVideo.pause(),currentVideo.src="",URL.revokeObjectURL(currentVideo.src),currentVideo=null),currentImageTexture&&currentImageTexture.dispose(),textureRotationSettings.enabled=!1,configureTexture(e),e.rotation=0,applyTextureToScreen(e,screenObject),currentImageTexture=e;const r=getMaterial(screenObject);r&&setTimeout(()=>{Object.assign(r,SCREEN_MATERIAL_SETTINGS),r.needsUpdate=!0},200)},void 0,()=>{})},r.readAsDataURL(e)}export function loadVideo(e){if(!screenObject)return;const r=document.createElement("video");r.src=URL.createObjectURL(e),r.crossOrigin="anonymous",r.loop=!0,r.muted=!0,r.playsInline=!0,r.addEventListener("loadedmetadata",()=>{r.play(),currentVideoTexture&&currentVideoTexture.dispose(),currentVideo&&(currentVideo.pause(),currentVideo.src="",URL.revokeObjectURL(currentVideo.src)),currentImageTexture&&(currentImageTexture.dispose(),currentImageTexture=null),textureRotationSettings.enabled=!1;const e=new THREE.VideoTexture(r);configureTexture(e),e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.rotation=0,applyTextureToScreen(e,screenObject),currentVideoTexture=e,currentVideo=r;const t=getMaterial(screenObject);t&&setTimeout(()=>{Object.assign(t,SCREEN_MATERIAL_SETTINGS),t.needsUpdate=!0},200)}),r.addEventListener("error",()=>{})}export function connectWebcam(){screenObject&&(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(e=>{currentVideoTexture&&(currentVideoTexture.dispose(),currentVideoTexture=null),currentVideo&&(currentVideo.pause(),currentVideo.srcObject=null,currentVideo=null),currentImageTexture&&(currentImageTexture.dispose(),currentImageTexture=null),currentWebcamStream&&(currentWebcamStream.getTracks().forEach(e=>e.stop()),currentWebcamStream=null),textureRotationSettings.enabled=!1;const r=document.createElement("video");r.srcObject=e,r.autoplay=!0,r.playsInline=!0,r.muted=!0,r.addEventListener("loadedmetadata",()=>{r.play();const t=new THREE.VideoTexture(r);configureTexture(t),t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.rotation=0,applyTextureToScreen(t,screenObject),currentVideoTexture=t,currentVideo=r,currentWebcamStream=e;const n=getMaterial(screenObject);n&&setTimeout(()=>{Object.assign(n,SCREEN_MATERIAL_SETTINGS),n.needsUpdate=!0},200)}),r.addEventListener("error",()=>{alert("Error accessing webcam.")})}).catch(e=>{alert("Could not access webcam. Please check permissions.")}):alert("Webcam access is not available in your browser."))}export function disconnectWebcam(){currentWebcamStream&&(currentWebcamStream.getTracks().forEach(e=>e.stop()),currentWebcamStream=null),currentVideoTexture&&(currentVideoTexture.dispose(),currentVideoTexture=null),currentVideo&&(currentVideo.pause(),currentVideo.srcObject=null,currentVideo=null)}export function setupDragAndDrop(){const e=document.getElementById("drop-zone");function r(e){e.preventDefault(),e.stopPropagation()}function t(e){if(!screenObject)return;const r=getMaterial(screenObject);r&&(e?(r.emissive=new THREE.Color(38655),r.emissiveIntensity=.8):(Object.assign(r,SCREEN_MATERIAL_SETTINGS),r.needsUpdate=!0))}document.addEventListener("dragenter",n=>{r(n),e.classList.add("drag-over"),t(!0)},!1),document.addEventListener("dragover",n=>{r(n),e.classList.add("drag-over"),t(!0)},!1),document.addEventListener("dragleave",n=>{r(n),0===n.clientX&&0===n.clientY&&(e.classList.remove("drag-over"),t(!1))},!1),document.addEventListener("drop",n=>{r(n),e.classList.remove("drag-over"),t(!1);const c=n.dataTransfer.files;if(c.length>0){const e=c[0];e.type.startsWith("image/")?loadImage(e):e.type.startsWith("video/")&&loadVideo(e)}},!1)}