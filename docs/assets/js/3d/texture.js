import*as THREE from"three";import{configureTexture,applyTextureToScreen,getMaterial}from"./utils.js";import{SCREEN_MATERIAL_SETTINGS}from"./config.js";import{screenSettings,textureRotationSettings,randomizeColors}from"../core/settings.js";import{camera}from"./scene.js";import{generatePolarGridTexture,polarGridSettings,startPulseAnimation,stopPulseAnimation,reinitializePulses,preloadCellImages,triggerScrambleBurst}from"./polar-grid-texture.js";import{audioSettings,startAudio,stopAudio,setMasterVolume,setReverbWet,setSpatialSpread,initAudio,setScrambleTrigger}from"./pulse-audio.js";import{lightingSettings,setAmbientIntensity,setAmbientColor,setFogEnabled,setFogColor,setFogNear,setFogFar,setToneMapping,setExposure,setDirectLightEnabled,setDirectIntensity,setDirectColor,getToneMappingOptions,setGradientStart,setGradientEnd,setSection1FadeStart,setSection2FadeEnd}from"./lighting.js";setScrambleTrigger(triggerScrambleBurst);import GUI from"lil-gui";let screenObject=null,currentVideoTexture=null,currentVideo=null,currentImageTexture=null,currentWebcamStream=null;export function setScreenObject(e){screenObject=e}export function getScreenObject(){return screenObject}export function getCurrentVideoTexture(){return currentVideoTexture}export function getCurrentVideo(){return currentVideo}export function getCurrentImageTexture(){return currentImageTexture}export function loadDefaultScreenTexture(e=screenSettings.defaultImage||"assets/media/background.png"){return screenObject?(currentImageTexture&&(currentImageTexture.dispose(),currentImageTexture=null),new Promise(async e=>{await preloadCellImages();const t=window.savedColorSettings||{},r=t.Main_Structure||{r:.4,g:.45,b:.5},o=t.Chairs||{r:.55,g:.32,b:.38},n=t.Floor||{r:.65,g:.52,b:.25},a=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0,i=generatePolarGridTexture(a?2048:4096,{backgroundColor:"#000000",numCircles:8,numRadialLines:36,showLabels:!0,labelColor:"#ffffff",mainColor:r,chairsColor:o,floorColor:n,curvedTexts:[{text:polarGridSettings.text1Content,row:polarGridSettings.text1Row,startSector:polarGridSettings.text1StartSector,textFontSize:polarGridSettings.text1FontSize,color:"#ffffff",flipX:polarGridSettings.text1FlipX,flipY:polarGridSettings.text1FlipY,cellMode:polarGridSettings.text1CellMode},{text:polarGridSettings.text2Content,row:polarGridSettings.text2Row,startSector:polarGridSettings.text2StartSector,textFontSize:polarGridSettings.text2FontSize,color:"#ffffff",flipX:polarGridSettings.text2FlipX,flipY:polarGridSettings.text2FlipY,cellMode:polarGridSettings.text2CellMode},{text:polarGridSettings.text3Content,row:polarGridSettings.text3Row,startSector:polarGridSettings.text3StartSector,textFontSize:polarGridSettings.text3FontSize,color:"#ffffff",flipX:polarGridSettings.text3FlipX,flipY:polarGridSettings.text3FlipY,cellMode:polarGridSettings.text3CellMode},{text:polarGridSettings.text4Content,row:polarGridSettings.text4Row,startSector:polarGridSettings.text4StartSector,textFontSize:polarGridSettings.text4FontSize,color:"#ffffff",flipX:polarGridSettings.text4FlipX,flipY:polarGridSettings.text4FlipY,cellMode:polarGridSettings.text4CellMode}]});configureTexture(i),i.rotation=0,applyTextureToScreen(i,screenObject),currentImageTexture=i,setupPolarGridGUI(),polarGridSettings.pulsesEnabled&&startPulseAnimation(i),e(i)})):Promise.resolve()}export function regeneratePolarGridTexture(){screenObject&&(stopPulseAnimation(),loadDefaultScreenTexture())}let polarGridGUI=null;function hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16)/255,g:parseInt(t[2],16)/255,b:parseInt(t[3],16)/255}:null}function rgbToHex(e){return`#${Math.round(255*e.r).toString(16).padStart(2,"0")}${Math.round(255*e.g).toString(16).padStart(2,"0")}${Math.round(255*e.b).toString(16).padStart(2,"0")}`}async function applyColorToMesh(e,t){const r=await import("./model.js"),{getMaterial:o}=await import("./utils.js");if(r.fbxMeshes){const n=r.fbxMeshes.find(t=>t.name===e);if(n){const e=o(n.mesh);e&&(e.color.setRGB(t.r,t.g,t.b),e.needsUpdate=!0)}}window.savedColorSettings||(window.savedColorSettings={}),window.savedColorSettings[e]=t}export function setupPolarGridGUI(){if(polarGridGUI)return;polarGridGUI=new GUI({title:"Dome Dreaming"}),polarGridGUI.domElement.style.position="fixed",polarGridGUI.domElement.style.top="10px",polarGridGUI.domElement.style.left="10px",polarGridGUI.domElement.style.zIndex="99999",polarGridGUI.domElement.style.display="none",window.addEventListener("keydown",e=>{if((e.metaKey||e.ctrlKey)&&"g"===e.key.toLowerCase()){e.preventDefault();const t="none"===polarGridGUI.domElement.style.display;polarGridGUI.domElement.style.display=t?"":"none"}});const e=polarGridGUI.addFolder("Typography");e.add(polarGridSettings,"globalFontSize",50,200,5).name("Global Font Size %").onChange(()=>regeneratePolarGridTexture());const t=e.addFolder("Text 1");t.add(polarGridSettings,"text1Content").name("Text").onChange(()=>regeneratePolarGridTexture()),t.add(polarGridSettings,"text1Row",1,8,1).name("Row (Circle)").onChange(()=>regeneratePolarGridTexture()),t.add(polarGridSettings,"text1StartSector",0,35,1).name("Start Sector").onChange(()=>regeneratePolarGridTexture()),t.add(polarGridSettings,"text1FontSize",20,200,5).name("Font Size %").onChange(()=>regeneratePolarGridTexture()),t.close();const r=e.addFolder("Text 2");r.add(polarGridSettings,"text2Content").name("Text").onChange(()=>regeneratePolarGridTexture()),r.add(polarGridSettings,"text2Row",1,8,1).name("Row (Circle)").onChange(()=>regeneratePolarGridTexture()),r.add(polarGridSettings,"text2StartSector",0,35,1).name("Start Sector").onChange(()=>regeneratePolarGridTexture()),r.add(polarGridSettings,"text2FontSize",20,200,5).name("Font Size %").onChange(()=>regeneratePolarGridTexture()),r.close();const o=e.addFolder("Text 3");o.add(polarGridSettings,"text3Content").name("Text").onChange(()=>regeneratePolarGridTexture()),o.add(polarGridSettings,"text3Row",1,8,1).name("Row (Circle)").onChange(()=>regeneratePolarGridTexture()),o.add(polarGridSettings,"text3StartSector",0,35,1).name("Start Sector").onChange(()=>regeneratePolarGridTexture()),o.add(polarGridSettings,"text3FontSize",20,200,5).name("Font Size %").onChange(()=>regeneratePolarGridTexture()),o.close();const n=e.addFolder("Text 4");n.add(polarGridSettings,"text4Content").name("Text").onChange(()=>regeneratePolarGridTexture()),n.add(polarGridSettings,"text4Row",1,8,1).name("Row (Circle)").onChange(()=>regeneratePolarGridTexture()),n.add(polarGridSettings,"text4StartSector",0,35,1).name("Start Sector").onChange(()=>regeneratePolarGridTexture()),n.add(polarGridSettings,"text4FontSize",20,200,5).name("Font Size %").onChange(()=>regeneratePolarGridTexture()),n.close();const a=e.addFolder("Style");a.add(polarGridSettings,"textOutline").name("Outline").onChange(()=>regeneratePolarGridTexture()),a.addColor(polarGridSettings,"textOutlineColor").name("Outline Color").onChange(()=>regeneratePolarGridTexture()),a.add(polarGridSettings,"textOutlineWidth",1,10,1).name("Outline Width").onChange(()=>regeneratePolarGridTexture()),a.add(polarGridSettings,"textShadow").name("Shadow").onChange(()=>regeneratePolarGridTexture()),a.add(polarGridSettings,"textShadowBlur",0,20,1).name("Shadow Blur").onChange(()=>regeneratePolarGridTexture()),a.add(polarGridSettings,"textVerticalOffset",.1,.9,.05).name("Radial Position").onChange(()=>regeneratePolarGridTexture()),a.close(),e.close();const i=polarGridGUI.addFolder("Grid"),d=i.addFolder("Lines");d.addColor(polarGridSettings,"gridLineColor").name("Color").onChange(()=>regeneratePolarGridTexture()),d.add(polarGridSettings,"lineWidth",.5,5,.5).name("Width").onChange(()=>regeneratePolarGridTexture()),d.add(polarGridSettings,"tickWidth",.5,4,.5).name("Tick Width").onChange(()=>regeneratePolarGridTexture()),d.add(polarGridSettings,"rimOffset",0,.2,.01).name("Rim Offset").onChange(()=>regeneratePolarGridTexture()),d.add(polarGridSettings,"dotSize",1,20,1).name("Dot Size").onChange(()=>regeneratePolarGridTexture()),d.close();const l=i.addFolder("Images");l.add(polarGridSettings,"imageCellsEnabled").name("Enable").onChange(()=>regeneratePolarGridTexture()),l.add(polarGridSettings,"imageCellCount",1,12,1).name("Count").onChange(()=>regeneratePolarGridTexture()),l.add(polarGridSettings,"imageThreshold").name("Threshold").onChange(()=>regeneratePolarGridTexture()),l.add(polarGridSettings,"imageThresholdLevel",.2,.8,.05).name("Threshold Level").onChange(()=>regeneratePolarGridTexture()),l.close();const s=i.addFolder("Rendering");s.add(polarGridSettings,"antialias").name("Antialiasing").onChange(()=>regeneratePolarGridTexture()),s.close(),i.close();const g=polarGridGUI.addFolder("Animation"),c=g.addFolder("Rotation");c.add(polarGridSettings,"textRotationEnabled").name("Rotate Text"),c.add(polarGridSettings,"textStepRotation").name("Step Mode (BPM)"),c.add(polarGridSettings,"textRotationBPM",10,120,5).name("Text BPM"),c.add(polarGridSettings,"textRotationSpeed",-2,2,.1).name("Continuous Speed"),c.add(textureRotationSettings,"enabled").name("Rotate Grid"),c.add(textureRotationSettings,"speed",-.1,.1,.005).name("Grid Speed"),c.close();const u=g.addFolder("Pulses");u.add(polarGridSettings,"pulsesEnabled").name("Enable").onChange(e=>{e&&currentImageTexture?startPulseAnimation(currentImageTexture):stopPulseAnimation()}),u.add(polarGridSettings,"pulseCount",1,20,1).name("Count").onChange(()=>reinitializePulses()),u.add(polarGridSettings,"pulseSpeed",.1,2,.1).name("Speed"),u.add(polarGridSettings,"pulseSize",4,30,1).name("Size"),u.add(polarGridSettings,"pulseGlow").name("Glow"),u.close(),g.close();const p=polarGridGUI.addFolder("Audio");p.add(audioSettings,"enabled").name("Enable Sound").onChange(async e=>{e?await startAudio():stopAudio()}),p.add(audioSettings,"masterVolume",0,1,.05).name("Volume").onChange(e=>setMasterVolume(e)),p.add(audioSettings,"tickBPM",20,180,5).name("Tick BPM"),p.add(audioSettings,"reverbWet",0,1,.05).name("Reverb").onChange(e=>setReverbWet(e)),p.add(audioSettings,"spatialSpread",1,20,1).name("3D Spread").onChange(e=>setSpatialSpread(e)),p.close();const S=polarGridGUI.addFolder("Colors"),m={get mainColor(){return rgbToHex(polarGridSettings.mainColor||{r:.4,g:.45,b:.5})},set mainColor(e){const t=hexToRgb(e);t&&(polarGridSettings.mainColor=t,window.savedColorSettings=window.savedColorSettings||{},window.savedColorSettings.Main_Structure=t,applyColorToMesh("Main_Structure",t),regeneratePolarGridTexture())},get chairsColor(){return rgbToHex(polarGridSettings.chairsColor||{r:.55,g:.32,b:.38})},set chairsColor(e){const t=hexToRgb(e);t&&(polarGridSettings.chairsColor=t,window.savedColorSettings=window.savedColorSettings||{},window.savedColorSettings.Chairs=t,applyColorToMesh("Chairs",t),regeneratePolarGridTexture())},get floorColor(){return rgbToHex(polarGridSettings.floorColor||{r:.65,g:.52,b:.25})},set floorColor(e){const t=hexToRgb(e);t&&(polarGridSettings.floorColor=t,window.savedColorSettings=window.savedColorSettings||{},window.savedColorSettings.Floor=t,applyColorToMesh("Floor",t),regeneratePolarGridTexture())}};S.addColor(m,"mainColor").name("Main Structure"),S.addColor(m,"chairsColor").name("Chairs"),S.addColor(m,"floorColor").name("Floor"),S.add({randomize:()=>{randomizeColors().then(()=>{regeneratePolarGridTexture()})}},"randomize").name("Randomise Colors"),S.close();const x=polarGridGUI.addFolder("Lighting"),G=x.addFolder("Exposure");G.add(lightingSettings,"toneMapping",getToneMappingOptions()).name("Tone Mapping").onChange(e=>setToneMapping(e)),G.add(lightingSettings,"exposure",0,3,.1).name("Exposure").onChange(e=>setExposure(e)),G.close();const T=x.addFolder("Ambient");T.add(lightingSettings,"ambientIntensity",0,2,.1).name("Intensity").onChange(e=>setAmbientIntensity(e)),T.addColor(lightingSettings,"ambientColor").name("Color").onChange(e=>setAmbientColor(e)),T.close();const C=x.addFolder("Direct Light");C.add(lightingSettings,"directLightEnabled").name("Enable").onChange(e=>setDirectLightEnabled(e)),C.add(lightingSettings,"directIntensity",0,5,.1).name("Intensity").onChange(e=>setDirectIntensity(e)),C.addColor(lightingSettings,"directColor").name("Color").onChange(e=>setDirectColor(e)),C.close();const h=x.addFolder("Fog");h.add(lightingSettings,"fogEnabled").name("Enable").onChange(e=>setFogEnabled(e)),h.addColor(lightingSettings,"fogColor").name("Color").onChange(e=>setFogColor(e)),h.add(lightingSettings,"fogNear",1,50,1).name("Near").onChange(e=>setFogNear(e)),h.add(lightingSettings,"fogFar",20,100,5).name("Far").onChange(e=>setFogFar(e)),h.close();const f=x.addFolder("Section Gradient");f.add(lightingSettings,"section1FadeStart",0,100,5).name("Section 1 Fade %").onChange(e=>setSection1FadeStart(e)),f.add(lightingSettings,"section2FadeEnd",0,100,5).name("Section 2 Fade %").onChange(e=>setSection2FadeEnd(e)),f.close(),x.close();const b=polarGridGUI.addFolder("Camera"),F=b.addFolder("Position");F.add(camera.position,"x",-20,20,.01).name("X").listen(),F.add(camera.position,"y",-20,20,.01).name("Y").listen(),F.add(camera.position,"z",-20,20,.01).name("Z").listen(),F.close();const E=b.addFolder("Rotation");E.add(camera.rotation,"x",-Math.PI,Math.PI,.01).name("X").listen(),E.add(camera.rotation,"y",-Math.PI,Math.PI,.01).name("Y").listen(),E.add(camera.rotation,"z",-Math.PI,Math.PI,.01).name("Z").listen(),E.close(),b.close(),polarGridSettings.regenerate=regeneratePolarGridTexture}export function loadImage(e){if(!screenObject)return;const t=new FileReader;t.onload=e=>{(new THREE.TextureLoader).load(e.target.result,e=>{currentVideoTexture&&(currentVideoTexture.dispose(),currentVideoTexture=null),currentVideo&&(currentVideo.pause(),currentVideo.src="",URL.revokeObjectURL(currentVideo.src),currentVideo=null),currentImageTexture&&currentImageTexture.dispose(),textureRotationSettings.enabled=!1,configureTexture(e),e.rotation=0,applyTextureToScreen(e,screenObject),currentImageTexture=e;const t=getMaterial(screenObject);t&&setTimeout(()=>{Object.assign(t,SCREEN_MATERIAL_SETTINGS),t.needsUpdate=!0},200)},void 0,()=>{})},t.readAsDataURL(e)}export function loadVideo(e){if(!screenObject)return;const t=document.createElement("video");t.src=URL.createObjectURL(e),t.crossOrigin="anonymous",t.loop=!0,t.muted=!0,t.playsInline=!0,t.addEventListener("loadedmetadata",()=>{t.play(),currentVideoTexture&&currentVideoTexture.dispose(),currentVideo&&(currentVideo.pause(),currentVideo.src="",URL.revokeObjectURL(currentVideo.src)),currentImageTexture&&(currentImageTexture.dispose(),currentImageTexture=null),textureRotationSettings.enabled=!1;const e=new THREE.VideoTexture(t);configureTexture(e),e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.rotation=0,applyTextureToScreen(e,screenObject),currentVideoTexture=e,currentVideo=t;const r=getMaterial(screenObject);r&&setTimeout(()=>{Object.assign(r,SCREEN_MATERIAL_SETTINGS),r.needsUpdate=!0},200)}),t.addEventListener("error",()=>{})}export function connectWebcam(){screenObject&&(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(e=>{currentVideoTexture&&(currentVideoTexture.dispose(),currentVideoTexture=null),currentVideo&&(currentVideo.pause(),currentVideo.srcObject=null,currentVideo=null),currentImageTexture&&(currentImageTexture.dispose(),currentImageTexture=null),currentWebcamStream&&(currentWebcamStream.getTracks().forEach(e=>e.stop()),currentWebcamStream=null),textureRotationSettings.enabled=!1;const t=document.createElement("video");t.srcObject=e,t.autoplay=!0,t.playsInline=!0,t.muted=!0,t.addEventListener("loadedmetadata",()=>{t.play();const r=new THREE.VideoTexture(t);configureTexture(r),r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r.rotation=0,applyTextureToScreen(r,screenObject),currentVideoTexture=r,currentVideo=t,currentWebcamStream=e;const o=getMaterial(screenObject);o&&setTimeout(()=>{Object.assign(o,SCREEN_MATERIAL_SETTINGS),o.needsUpdate=!0},200)}),t.addEventListener("error",()=>{alert("Error accessing webcam.")})}).catch(e=>{alert("Could not access webcam. Please check permissions.")}):alert("Webcam access is not available in your browser."))}export function disconnectWebcam(){currentWebcamStream&&(currentWebcamStream.getTracks().forEach(e=>e.stop()),currentWebcamStream=null),currentVideoTexture&&(currentVideoTexture.dispose(),currentVideoTexture=null),currentVideo&&(currentVideo.pause(),currentVideo.srcObject=null,currentVideo=null)}export function setupDragAndDrop(){const e=document.getElementById("drop-zone");function t(e){e.preventDefault(),e.stopPropagation()}function r(e){if(!screenObject)return;const t=getMaterial(screenObject);t&&(e?(t.emissive=new THREE.Color(38655),t.emissiveIntensity=.8):(Object.assign(t,SCREEN_MATERIAL_SETTINGS),t.needsUpdate=!0))}document.addEventListener("dragenter",o=>{t(o),e.classList.add("drag-over"),r(!0)},!1),document.addEventListener("dragover",o=>{t(o),e.classList.add("drag-over"),r(!0)},!1),document.addEventListener("dragleave",o=>{t(o),0===o.clientX&&0===o.clientY&&(e.classList.remove("drag-over"),r(!1))},!1),document.addEventListener("drop",o=>{t(o),e.classList.remove("drag-over"),r(!1);const n=o.dataTransfer.files;if(n.length>0){const e=n[0];e.type.startsWith("image/")?loadImage(e):e.type.startsWith("video/")&&loadVideo(e)}},!1)}