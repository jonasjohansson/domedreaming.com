import*as THREE from"three";import{GLTFLoader}from"three/addons/loaders/GLTFLoader.js";import{DRACOLoader}from"three/addons/loaders/DRACOLoader.js";import{scene,camera}from"./scene.js";import{getMaterial,safeTraverse,pruneObjectChildren}from"./utils.js";import*as settings from"../core/settings.js";import{euler,setModelLoaded}from"./camera.js";import{setScreenObject,loadDefaultScreenTexture,setupDragAndDrop,getScreenObject}from"./texture.js";import{verifyNavmeshAtStartPosition,initNavmesh,getNavMeshQuery}from"./navmesh.js";import{initScreenLighting}from"./screen-lighting.js";export let wisdomeModel=null;export let fbxMeshes=[];export let glbLights=[];export let glbLightsGroup=null;export let hotspots=[];export function loadModel(){const e=new GLTFLoader,t=new DRACOLoader;t.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/libs/draco/gltf/"),e.setDRACOLoader(t);const s=document.title;e.load("assets/models/wisdome.glb",e=>{if(document.title=s,!e||!e.scene){const e=document.getElementById("loading-overlay");return void(e&&(e.innerHTML='<div style="color: #ff4444; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">Error: Model scene is missing.</div>'))}const t=e.scene;wisdomeModel=t,t.scale.setScalar(1),t.position.set(0,0,0),pruneObjectChildren(t),glbLightsGroup=new THREE.Group,glbLightsGroup.name="GLBLights";const o=()=>{safeTraverse(t,e=>{e.isLight&&(glbLights.push(e),glbLightsGroup.add(e))})};"requestIdleCallback"in window?requestIdleCallback(o,{timeout:100}):o(),0===glbLights.length&&safeTraverse(t,e=>{(e instanceof THREE.Light||e instanceof THREE.DirectionalLight||e instanceof THREE.PointLight||e instanceof THREE.SpotLight||e instanceof THREE.RectAreaLight||e instanceof THREE.HemisphereLight)&&(glbLights.includes(e)||(glbLights.push(e),glbLightsGroup.add(e)))}),glbLights=glbLights.filter(e=>!(e instanceof THREE.HemisphereLight)),glbLights.length>0&&(scene.add(glbLightsGroup),glbLights.forEach(e=>{e instanceof THREE.DirectionalLight?(e.intensity=3,e.position.set(2,15,5)):e instanceof THREE.PointLight?(e.intensity=0,e.visible=!1):e.intensity=0})),safeTraverse(t,e=>{"Hotspots"===e.name&&safeTraverse(e,e=>{if("Hotspot.001"===e.name||e.name.includes("Hotspot")){const t=new THREE.Vector3;e.getWorldPosition(t),hotspots.push({object:e,position:t,name:e.name,triggered:!1})}})}),safeTraverse(t,e=>{if(e.isMesh){const t=e.name.toLowerCase();if(t.includes("screen")||t.includes("display")||t.includes("monitor")||t.includes("panel")||t.includes("projection")||t.includes("canvas"))setScreenObject(e),e.visible=!0;else{let t=getMaterial(e);const s=t?.color?t.color.clone():new THREE.Color(16777215);if(t){if(void 0!==t.metalness&&(t.metalness=Math.max(t.metalness||0,.1)),void 0!==t.roughness&&(t.roughness=Math.min(t.roughness||.5,.8)),t.map&&(t.map.colorSpace=THREE.SRGBColorSpace),t.isMeshBasicMaterial){const s=new THREE.MeshStandardMaterial({color:t.color,map:t.map,transparent:t.transparent,opacity:t.opacity,metalness:.1,roughness:.5});e.material=s,t=s}t.needsUpdate=!0}fbxMeshes.push({mesh:e,name:e.name||"Unnamed",originalColor:s})}}});let n=!1;safeTraverse(t,e=>{e.isMesh&&e.name&&(e.name.toLowerCase().includes("screen")||e.name.toLowerCase().includes("display")||e.name.toLowerCase().includes("monitor")||e.name.toLowerCase().includes("panel")||e.name.toLowerCase().includes("projection")||e.name.toLowerCase().includes("canvas"))&&(n=!0)}),!n&&t&&t.children.length>0&&safeTraverse(t,e=>{e.isMesh&&!n&&(setScreenObject(e),e.visible=!0,fbxMeshes=fbxMeshes.filter(t=>t.mesh!==e),n=!0)}),scene.add(t);const i=settings.startCameraPosition,a=i&&i.y>1&&i.y<10?i:{x:0,y:5.4,z:-4.3},r=settings.startCameraRotation||{x:-2.9,y:0,z:3.121154018741333};function l(){const e=document.getElementById("loading-overlay");e&&(e.classList.add("fade-out"),setTimeout(()=>{e.remove()},500));const t=document.getElementById("canvas-container"),s=document.getElementById("info-panel");t&&t.classList.add("loaded"),s&&s.classList.add("loaded")}camera.position.set(a.x,a.y,a.z),camera.rotation.set(r.x,r.y,r.z),camera.updateMatrixWorld(),euler.set(r.x,r.y,r.z,"YXZ"),setModelLoaded(!0),getNavMeshQuery()&&verifyNavmeshAtStartPosition(),initNavmesh(),setupDragAndDrop(),Promise.all([import("../core/settings.js").then(e=>e.applySettingsToScene()),loadDefaultScreenTexture().catch(e=>null)]).then(()=>{setTimeout(()=>{const e=t.children.find(e=>{const t=e.name?.toLowerCase()||"";return t.includes("screen")||t.includes("monitor")||t.includes("panel")||t.includes("projection")||t.includes("canvas")});e&&initScreenLighting(e),l()},100)}).catch(e=>{setTimeout(l,1e3)})},e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);document.title=`${t}% ${s}`}},e=>{document.title=s;const t=document.getElementById("loading-overlay");t&&(t.innerHTML='<div style="color: #ff4444; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">Error loading 3D model.</div>')})}