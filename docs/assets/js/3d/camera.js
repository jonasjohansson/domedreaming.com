import*as THREE from"three";import{canvas,camera}from"./scene.js";import{cameraSettings}from"../core/settings.js";import{touchMovement}from"./movement.js";export let isPointerLocked=!1;export let isTouching=!1;export let euler=new THREE.Euler(-2.85,0,3.121154018741333,"YXZ");export let modelLoaded=!1;export let touchStartX=0;export let touchStartY=0;export let keys={};export let qeRotationSpeed=0;export function setModelLoaded(e){modelLoaded=e}export function setQeRotationSpeed(e){qeRotationSpeed=e}export function setupCameraControls(){let e=!1,t=0,n=0;canvas.addEventListener("mousedown",a=>{modelLoaded&&(e=!0,t=a.clientX,n=a.clientY,euler.setFromQuaternion(camera.quaternion),canvas.style.cursor="grabbing")}),canvas.addEventListener("mousemove",a=>{if(!e||!modelLoaded)return;const o=a.clientX-t,r=a.clientY-n;euler.y-=o*cameraSettings.sensitivity,euler.x-=r*cameraSettings.sensitivity,euler.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,euler.x)),camera.quaternion.setFromEuler(euler),t=a.clientX,n=a.clientY}),canvas.addEventListener("mouseup",()=>{e=!1,canvas.style.cursor="default"}),canvas.addEventListener("mouseleave",()=>{e=!1,canvas.style.cursor="default"});let a=null;function o(e,t){const n=e.toLowerCase();["q","w","a","s","d","e"].includes(n)&&document.querySelectorAll(`[data-key="${n}"]`).forEach(e=>{t?e.classList.add("active"):e.classList.remove("active")})}canvas.addEventListener("touchstart",e=>{if(modelLoaded&&(e.preventDefault(),1===e.touches.length&&null===a)){const t=e.touches[0];a=t.identifier,touchStartX=t.clientX,touchStartY=t.clientY,isTouching=!0,euler.setFromQuaternion(camera.quaternion)}},{passive:!1}),canvas.addEventListener("touchmove",e=>{if(modelLoaded&&(e.preventDefault(),null!==a&&1===e.touches.length)){const t=Array.from(e.touches).find(e=>e.identifier===a);if(t){const e=t.clientX-touchStartX,n=t.clientY-touchStartY;euler.y-=e*cameraSettings.sensitivity,euler.x-=n*cameraSettings.sensitivity,euler.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,euler.x)),camera.quaternion.setFromEuler(euler),touchStartX=t.clientX,touchStartY=t.clientY}}},{passive:!1}),canvas.addEventListener("touchend",e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)e.changedTouches[t].identifier===a&&(a=null,isTouching=!1)},{passive:!1}),canvas.addEventListener("touchcancel",e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)e.changedTouches[t].identifier===a&&(a=null,isTouching=!1)},{passive:!1}),window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();keys[t]=!0,o(e.key,!0),"c"===e.key||e.key,"q"!==e.key&&"Q"!==e.key||setQeRotationSpeed(1.5),"e"!==e.key&&"E"!==e.key||setQeRotationSpeed(-1.5)}),window.addEventListener("keyup",e=>{const t=e.key.toLowerCase();keys[t]=!1,o(e.key,!1),"q"!==e.key&&"Q"!==e.key&&"e"!==e.key&&"E"!==e.key||(qeRotationSpeed=0)})}