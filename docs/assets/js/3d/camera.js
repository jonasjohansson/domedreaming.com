import*as THREE from"three";import{canvas,camera}from"./scene.js";import{cameraSettings}from"../core/settings.js";import{touchMovement}from"./movement.js";export let isPointerLocked=!1;export let isTouching=!1;export let euler=new THREE.Euler(-3,0,3.121154018741333,"YXZ");export let modelLoaded=!1;export let touchStartX=0;export let touchStartY=0;export let keys={};export let qeRotationSpeed=0;export function setModelLoaded(e){modelLoaded=e}export function setQeRotationSpeed(e){qeRotationSpeed=e}export function setupCameraControls(){function e(){const e=isPointerLocked;isPointerLocked=document.pointerLockElement===canvas||document.mozPointerLockElement===canvas||document.webkitPointerLockElement===canvas,!e&&isPointerLocked&&modelLoaded&&euler.setFromQuaternion(camera.quaternion)}document.addEventListener("pointerlockchange",e),document.addEventListener("mozpointerlockchange",e),document.addEventListener("webkitpointerlockchange",e),canvas.addEventListener("mousemove",function(e){if(!isPointerLocked||!modelLoaded)return;const t=e.movementX||e.mozMovementX||e.webkitMovementX||0,o=e.movementY||e.mozMovementY||e.webkitMovementY||0;euler.y-=t*cameraSettings.sensitivity,euler.x-=o*cameraSettings.sensitivity,euler.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,euler.x)),camera.quaternion.setFromEuler(euler)});let t=null;function o(e,t){const o=e.toLowerCase();["q","w","a","s","d","e"].includes(o)&&document.querySelectorAll(`[data-key="${o}"]`).forEach(e=>{t?e.classList.add("active"):e.classList.remove("active")})}canvas.addEventListener("touchstart",e=>{if(document.body.classList.contains("dome-mode")&&modelLoaded){if(e.preventDefault(),1===e.touches.length&&null===t){const o=e.touches[0];t=o.identifier,touchStartX=o.clientX,touchStartY=o.clientY,isTouching=!0,euler.setFromQuaternion(camera.quaternion)}2===e.touches.length&&(touchMovement.forward=!0)}},{passive:!1}),canvas.addEventListener("touchmove",e=>{if(document.body.classList.contains("dome-mode")&&modelLoaded){if(e.preventDefault(),null!==t){const o=Array.from(e.touches).find(e=>e.identifier===t);if(o){const e=o.clientX-touchStartX,t=o.clientY-touchStartY;euler.y-=e*cameraSettings.sensitivity,euler.x-=t*cameraSettings.sensitivity,euler.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,euler.x)),camera.quaternion.setFromEuler(euler),touchStartX=o.clientX,touchStartY=o.clientY}}2===e.touches.length?(touchMovement.forward=!0,touchMovement.backward=!1,touchMovement.left=!1,touchMovement.right=!1):1===e.touches.length&&(touchMovement.forward=!1)}},{passive:!1}),canvas.addEventListener("touchend",e=>{if(document.body.classList.contains("dome-mode")){e.preventDefault();for(let o=0;o<e.changedTouches.length;o++)e.changedTouches[o].identifier===t&&(t=null,isTouching=!1);e.touches.length<2&&(touchMovement.forward=!1,touchMovement.backward=!1,touchMovement.left=!1,touchMovement.right=!1)}},{passive:!1}),canvas.addEventListener("touchcancel",e=>{if(document.body.classList.contains("dome-mode")){e.preventDefault();for(let o=0;o<e.changedTouches.length;o++)e.changedTouches[o].identifier===t&&(t=null,isTouching=!1);touchMovement.forward=!1,touchMovement.backward=!1,touchMovement.left=!1,touchMovement.right=!1}},{passive:!1}),window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();keys[t]=!0,o(e.key,!0),"c"===e.key||e.key,"q"!==e.key&&"Q"!==e.key||setQeRotationSpeed(1.5),"e"!==e.key&&"E"!==e.key||setQeRotationSpeed(-1.5)}),window.addEventListener("keyup",e=>{const t=e.key.toLowerCase();keys[t]=!1,o(e.key,!1),"q"!==e.key&&"Q"!==e.key&&"e"!==e.key&&"E"!==e.key||(qeRotationSpeed=0)})}