import*as THREE from"three";import{scene}from"./scene.js";import{getCurrentImageTexture,getCurrentVideoTexture,getScreenObject}from"./texture.js";let screenLight=null,screenObject=null,hemisphereLight=null,secondaryLight=null,lastColorUpdate=0;const COLOR_UPDATE_INTERVAL=100;let colorSamplingEnabled=!0;const hsl={h:0,s:0,l:0};export function initScreenLighting(e){return screenObject=e,{screenLight:null,hemisphereLight:null,secondaryLight:null}}function sampleTextureColor(e){if(!e||!e.image)return null;const t=e.image,n=document.createElement("canvas"),r=n.getContext("2d"),o=64;n.width=o,n.height=o;try{r.drawImage(t,0,0,o,o);const e=r.getImageData(0,0,o,o).data;let n=0,i=0,l=0;const s=4096;for(let t=0;t<e.length;t+=4)n+=e[t],i+=e[t+1],l+=e[t+2];return n/=s,i/=s,l/=s,new THREE.Color(n/255,i/255,l/255)}catch(e){return null}}export function updateScreenLighting(e){if(!screenLight||!colorSamplingEnabled)return;if(e-lastColorUpdate<100)return;lastColorUpdate=e;let t=null;const n=getCurrentImageTexture(),r=getCurrentVideoTexture();if(r&&r.image?t=sampleTextureColor(r):n&&(t=sampleTextureColor(n)),t){const e=t.clone();if(e.getHSL(hsl),hsl.s=Math.min(1,1.5*hsl.s),hsl.l=Math.min(1,1.2*hsl.l),e.setHSL(hsl.h,hsl.s,hsl.l),screenLight.color.copy(e),screenLight.intensity=3,hemisphereLight){const t=(new THREE.Color).lerpColors(new THREE.Color(16777215),e,.6);hemisphereLight.color.copy(t),hemisphereLight.intensity=1.2}secondaryLight&&(secondaryLight.color.copy(e),secondaryLight.intensity=2);const n=getScreenObject();if(n){const e=new THREE.Vector3;n.getWorldPosition(e),screenLight.position.copy(e),screenLight.position.z+=.5,secondaryLight&&(secondaryLight.position.copy(e),secondaryLight.position.z+=.3,secondaryLight.position.y+=.2)}}}export function setColorSamplingEnabled(e){colorSamplingEnabled=e}export function getScreenLight(){return screenLight}