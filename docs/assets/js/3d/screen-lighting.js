import*as THREE from"three";import{scene}from"./scene.js";import{getCurrentImageTexture,getCurrentVideoTexture,getScreenObject}from"./texture.js";let screenLight=null,screenObject=null,hemisphereLight=null,secondaryLight=null,lastColorUpdate=0;const COLOR_UPDATE_INTERVAL=100;let colorSamplingEnabled=!0;const hsl={h:0,s:0,l:0};export function initScreenLighting(e){return screenObject=e,screenLight=new THREE.PointLight(16777215,2,30),screenLight.position.set(0,0,0),scene.add(screenLight),hemisphereLight=new THREE.HemisphereLight(16777215,1710618,.8),hemisphereLight.position.set(0,5,0),scene.add(hemisphereLight),secondaryLight=new THREE.PointLight(16777215,1.5,25),secondaryLight.position.set(0,0,0),scene.add(secondaryLight),{screenLight:screenLight,hemisphereLight:hemisphereLight,secondaryLight:secondaryLight}}function sampleTextureColor(e){if(!e||!e.image)return null;const t=e.image,n=document.createElement("canvas"),i=n.getContext("2d"),r=64;n.width=r,n.height=r;try{i.drawImage(t,0,0,r,r);const e=i.getImageData(0,0,r,r).data;let n=0,o=0,s=0;const h=4096;for(let t=0;t<e.length;t+=4)n+=e[t],o+=e[t+1],s+=e[t+2];return n/=h,o/=h,s/=h,new THREE.Color(n/255,o/255,s/255)}catch(e){return null}}export function updateScreenLighting(e){if(!screenLight||!colorSamplingEnabled)return;if(e-lastColorUpdate<100)return;lastColorUpdate=e;let t=null;const n=getCurrentImageTexture(),i=getCurrentVideoTexture();if(i&&i.image?t=sampleTextureColor(i):n&&(t=sampleTextureColor(n)),t){const e=t.clone();if(e.getHSL(hsl),hsl.s=Math.min(1,1.5*hsl.s),hsl.l=Math.min(1,1.2*hsl.l),e.setHSL(hsl.h,hsl.s,hsl.l),screenLight.color.copy(e),screenLight.intensity=3,hemisphereLight){const t=(new THREE.Color).lerpColors(new THREE.Color(16777215),e,.6);hemisphereLight.color.copy(t),hemisphereLight.intensity=1.2}secondaryLight&&(secondaryLight.color.copy(e),secondaryLight.intensity=2);const n=getScreenObject();if(n){const e=new THREE.Vector3;n.getWorldPosition(e),screenLight.position.copy(e),screenLight.position.z+=.5,secondaryLight&&(secondaryLight.position.copy(e),secondaryLight.position.z+=.3,secondaryLight.position.y+=.2)}}}export function setColorSamplingEnabled(e){colorSamplingEnabled=e}export function getScreenLight(){return screenLight}