import*as THREE from"three";import{camera}from"./scene.js";import{CAMERA_HEIGHT,NAVMESH_SEARCH_BOX}from"./config.js";import*as settings from"../core/settings.js";import{keys,qeRotationSpeed,euler,modelLoaded,setQeRotationSpeed}from"./camera.js";import{hotspots}from"./model.js";let navMeshQuery=null;export let touchMovement={forward:!1,backward:!1,left:!1,right:!1,rotateLeft:!1,rotateRight:!1};export function setNavMeshQuery(e){navMeshQuery=e}export function updateMovement(){if(!modelLoaded)return;camera.updateMatrixWorld();const e=new THREE.Vector3;e.setFromMatrixColumn(camera.matrixWorld,2),e.multiplyScalar(-1).normalize();const t=new THREE.Vector3;t.setFromMatrixColumn(camera.matrixWorld,0),t.normalize();const o=new THREE.Vector3,a=settings.moveSpeed;keys.w&&o.add(e.clone().multiplyScalar(a)),keys.s&&o.add(e.clone().multiplyScalar(-a)),keys.a&&o.add(t.clone().multiplyScalar(-a)),keys.d&&o.add(t.clone().multiplyScalar(a));const n=2*a;if(touchMovement.forward&&o.add(e.clone().multiplyScalar(n)),touchMovement.backward&&o.add(e.clone().multiplyScalar(-n)),touchMovement.left&&o.add(t.clone().multiplyScalar(-n)),touchMovement.right&&o.add(t.clone().multiplyScalar(n)),0!==o.length())if(navMeshQuery){const e=camera.position.clone();e.x+=o.x,e.z+=o.z;const t={x:e.x,y:e.y-CAMERA_HEIGHT,z:e.z},a=navMeshQuery.findClosestPoint(t,{halfExtents:NAVMESH_SEARCH_BOX});if(a.success)camera.position.set(a.point.x,a.point.y+CAMERA_HEIGHT,a.point.z);else{const t=navMeshQuery.findClosestPoint({x:e.x,y:camera.position.y-CAMERA_HEIGHT,z:camera.position.z},{halfExtents:NAVMESH_SEARCH_BOX});if(t.success)camera.position.set(t.point.x,t.point.y+CAMERA_HEIGHT,camera.position.z);else{const t=navMeshQuery.findClosestPoint({x:camera.position.x,y:camera.position.y-CAMERA_HEIGHT,z:e.z},{halfExtents:NAVMESH_SEARCH_BOX});t.success&&camera.position.set(camera.position.x,t.point.y+CAMERA_HEIGHT,t.point.z)}}}else camera.position.add(o)}export function constrainToNavmesh(){if(!navMeshQuery)return;const e={x:camera.position.x,y:camera.position.y-CAMERA_HEIGHT,z:camera.position.z},t=navMeshQuery.findClosestPoint(e,{halfExtents:NAVMESH_SEARCH_BOX});t.success&&(camera.position.y=t.point.y+CAMERA_HEIGHT)}export function updateRotation(e){if(keys.q||keys.Q?setQeRotationSpeed(settings.cameraSettings.rotationSpeed*(Math.PI/180)):keys.e||keys.E?setQeRotationSpeed(-settings.cameraSettings.rotationSpeed*(Math.PI/180)):setQeRotationSpeed(0),0!==qeRotationSpeed&&modelLoaded&&(euler.y+=qeRotationSpeed*e,camera.quaternion.setFromEuler(euler)),modelLoaded){const t=1.5;touchMovement.rotateLeft&&(euler.y+=t*e,camera.quaternion.setFromEuler(euler)),touchMovement.rotateRight&&(euler.y-=t*e,camera.quaternion.setFromEuler(euler))}}export function checkHotspots(){if(modelLoaded&&hotspots&&0!==hotspots.length)for(let e=hotspots.length-1;e>=0;e--){const t=hotspots[e];if(!t||!t.object||t.triggered)continue;const o=camera.position.x-t.position.x,a=camera.position.z-t.position.z;if(Math.sqrt(o*o+a*a)<.4){t.triggered=!0,t.object.parent&&t.object.parent.remove(t.object),hotspots.splice(e,1),alert("");break}}}