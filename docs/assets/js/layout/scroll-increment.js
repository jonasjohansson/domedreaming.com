import{scrollSettings}from"../core/settings.js";import{getRowHeight}from"../core/utils.js";let isScrolling=!1,lastScrollTime=0;const SCROLL_DELAY=30;let touchStartY=0,touchStartTime=0,touchMoved=!1,lastTouchY=0,touchScrollAccumulator=0;const MIN_SWIPE_DISTANCE=20;function getNearestRowIncrement(t){const o=2*getRowHeight();return Math.round(t/o)*o}function snapToNearestRow(){if(isScrolling)return;const t=window.pageYOffset||document.documentElement.scrollTop,o=getNearestRowIncrement(t);Math.abs(t-o)>1&&(isScrolling=!0,window.scrollTo({top:o,behavior:"auto"}),setTimeout(()=>{isScrolling=!1},50))}function handleScroll(){if(isScrolling)return;const t=window.pageYOffset||document.documentElement.scrollTop,o=getNearestRowIncrement(t),e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?5:1;Math.abs(t-o)>e&&snapToNearestRow()}function scrollToRowIncrement(t){const o=Date.now();if(o-lastScrollTime<30)return;const e=getRowHeight(),n=window.pageYOffset||document.documentElement.scrollTop,c=2*e;if(0!==t){const e=(Math.round(n/c)+t)*c,l=Math.max(document.body.scrollHeight-window.innerHeight,document.documentElement.scrollHeight-window.innerHeight),s=Math.max(0,Math.min(e,l));Math.abs(s-n)>1&&(lastScrollTime=o,window.scrollTo({top:s,behavior:"auto"}))}}function handleWheel(t){if(document.body.classList.contains("dome-mode"))return;t.preventDefault();const o=t.deltaY;let e=0;o>0?e=1:o<0&&(e=-1),0!==e&&scrollToRowIncrement(e)}function handleTouchStart(t){document.body.classList.contains("dome-mode")||1===t.touches.length&&(touchStartY=t.touches[0].clientY,lastTouchY=touchStartY,touchStartTime=Date.now(),touchMoved=!1,touchScrollAccumulator=0)}function handleTouchMove(t){if(document.body.classList.contains("dome-mode"))return;if(1!==t.touches.length)return;t.preventDefault();const o=t.touches[0].clientY,e=lastTouchY-o,n=touchStartY-o;Math.abs(n)>10&&(touchMoved=!0),touchScrollAccumulator+=e,lastTouchY=o;const c=2*getRowHeight()*.2;Math.abs(touchScrollAccumulator)>=c&&(scrollToRowIncrement(touchScrollAccumulator>0?1:-1),touchScrollAccumulator%=c)}function handleTouchEnd(t){document.body.classList.contains("dome-mode")||(t.preventDefault(),touchMoved=!1,touchScrollAccumulator=0)}export function initScrollIncrement(){if(!scrollSettings.enabled)return;if(document.body.classList.contains("dome-mode"))return;window.addEventListener("wheel",handleWheel,{passive:!1}),document.addEventListener("touchstart",handleTouchStart,{passive:!1}),document.addEventListener("touchmove",handleTouchMove,{passive:!1}),document.addEventListener("touchend",handleTouchEnd,{passive:!1});let t=null;window.addEventListener("scroll",()=>{isScrolling||(t&&clearTimeout(t),t=setTimeout(()=>{handleScroll(),t=null},30))},{passive:!0}),window.addEventListener("load",()=>{setTimeout(()=>{snapToNearestRow()},100)}),window.addEventListener("resize",()=>{setTimeout(()=>{snapToNearestRow()},100)})}