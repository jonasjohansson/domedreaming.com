import{scrollSettings}from"../core/settings.js";import{getRowHeight,isMobile}from"../core/utils.js";let isScrolling=!1,lastScrollTime=0;const SCROLL_DELAY=30;let touchStartY=0,touchStartTime=0,touchMoved=!1,lastTouchY=0,touchScrollAccumulator=0;const MIN_SWIPE_DISTANCE=20;function getNearestRowIncrement(t){const e=2*getRowHeight();return Math.round(t/e)*e}function snapToNearestRow(){if(isScrolling)return;const t=window.pageYOffset||document.documentElement.scrollTop,e=getNearestRowIncrement(t);Math.abs(t-e)>1&&(isScrolling=!0,window.scrollTo({top:e,behavior:"auto"}),setTimeout(()=>{isScrolling=!1},50))}function handleScroll(){if(isScrolling)return;const t=window.pageYOffset||document.documentElement.scrollTop,e=getNearestRowIncrement(t),o=isMobile()?5:1;Math.abs(t-e)>o&&snapToNearestRow()}function scrollToRowIncrement(t){const e=Date.now();if(e-lastScrollTime<30)return;const o=getRowHeight(),n=window.pageYOffset||document.documentElement.scrollTop,c=2*o;if(0!==t){const o=(Math.round(n/c)+t)*c,l=Math.max(document.body.scrollHeight-window.innerHeight,document.documentElement.scrollHeight-window.innerHeight),s=Math.max(0,Math.min(o,l));Math.abs(s-n)>1&&(lastScrollTime=e,window.scrollTo({top:s,behavior:"auto"}))}}function handleWheel(t){if(document.body.classList.contains("dome-mode"))return;t.preventDefault();const e=t.deltaY;let o=0;e>0?o=1:e<0&&(o=-1),0!==o&&scrollToRowIncrement(o)}function handleTouchStart(t){if(document.body.classList.contains("dome-mode"))return;const e=t.target;e.closest("a")||e.closest("button")||"A"===e.tagName||"BUTTON"===e.tagName||1===t.touches.length&&(touchStartY=t.touches[0].clientY,lastTouchY=touchStartY,touchStartTime=Date.now(),touchMoved=!1,touchScrollAccumulator=0)}function handleTouchMove(t){if(document.body.classList.contains("dome-mode"))return;const e=t.target;if(e.closest("a")||e.closest("button")||"A"===e.tagName||"BUTTON"===e.tagName)return;if(1!==t.touches.length)return;t.preventDefault();const o=t.touches[0].clientY,n=lastTouchY-o,c=touchStartY-o;Math.abs(c)>10&&(touchMoved=!0),touchScrollAccumulator+=n,lastTouchY=o;const l=2*getRowHeight()*.2;Math.abs(touchScrollAccumulator)>=l&&(scrollToRowIncrement(touchScrollAccumulator>0?1:-1),touchScrollAccumulator%=l)}function handleTouchEnd(t){if(document.body.classList.contains("dome-mode"))return;const e=t.target;e.closest("a")||e.closest("button")||"A"===e.tagName||"BUTTON"===e.tagName||(t.preventDefault(),touchMoved=!1,touchScrollAccumulator=0)}export function initScrollIncrement(){if(!scrollSettings.enabled)return;if(document.body.classList.contains("dome-mode"))return;window.addEventListener("wheel",handleWheel,{passive:!1}),document.addEventListener("touchstart",handleTouchStart,{passive:!1}),document.addEventListener("touchmove",handleTouchMove,{passive:!1}),document.addEventListener("touchend",handleTouchEnd,{passive:!1});let t=null;window.addEventListener("scroll",()=>{isScrolling||(t&&clearTimeout(t),t=setTimeout(()=>{handleScroll(),t=null},30))},{passive:!0}),window.addEventListener("load",()=>{setTimeout(()=>{snapToNearestRow()},100)}),window.addEventListener("resize",()=>{setTimeout(()=>{snapToNearestRow()},100)})}