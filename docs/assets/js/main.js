let THREE,scene,camera,renderer,canvas,resetCamera,setupLighting,initPostProcessing,updatePostProcessing,setupCameraControls,euler,loadModel,updateMovement,updateRotation,fbxMeshes,glbLights,getCurrentImageTexture,getCurrentVideoTexture,connectWebcam,loadImage,loadVideo,disconnectWebcam,loadDefaultScreenTexture,updateScreenLighting,touchMovement,updateListenerPosition,startAudio,stopAudio,threeJsLoaded=!1;import{loadSettings,currentCameraPosition,currentCameraRotation,startCameraPosition,startCameraRotation,saveSettings,textureRotationSettings}from"./core/settings.js";import{initScrollIncrement}from"./layout/scroll-increment.js";import{initGridDotsSystem}from"./layout/grid-dots.js";import{initDashboard}from"./ui/dashboard.js";import{initResponsiveHeights}from"./layout/responsive-height.js";import{updateViewportHeightCSS}from"./core/utils.js";import{initDomeMode,setCanvas,setAudioFunctions}from"./ui/dome-mode.js";import{initTouchControls,setTouchMovementRef}from"./ui/touch-controls.js";let animationFrameId=null,lastTime=0,lastCameraSaveTime=0;const CAMERA_SAVE_INTERVAL=2e3;async function init(){await new Promise(e=>{"scheduler"in window&&"postTask"in window.scheduler?window.scheduler.postTask(()=>e(),{priority:"user-blocking"}):"requestIdleCallback"in window?requestIdleCallback(()=>e(),{timeout:0}):setTimeout(()=>e(),0)}),await loadSettings(),await new Promise(e=>setTimeout(e,0)),updateViewportHeightCSS(),"requestIdleCallback"in window?requestIdleCallback(()=>{initScrollIncrement(),initResponsiveHeights(),initDashboard()},{timeout:100}):setTimeout(()=>{initScrollIncrement(),initResponsiveHeights(),initDashboard()},0),"requestIdleCallback"in window?requestIdleCallback(()=>{initGridDotsSystem()},{timeout:500}):setTimeout(()=>{initGridDotsSystem()},50),"requestIdleCallback"in window?requestIdleCallback(()=>{setupEventListeners()},{timeout:100}):setTimeout(()=>{setupEventListeners()},0)}async function loadThreeJS(){if(!threeJsLoaded)try{THREE=await import("three");const e=await import("./3d/scene.js"),t=await import("./3d/camera.js"),o=await import("./3d/lighting.js"),a=await import("./3d/postprocessing.js");scene=e.scene,camera=e.camera,renderer=e.renderer,canvas=e.canvas,resetCamera=e.resetCamera,setupLighting=o.setupLighting,initPostProcessing=a.initPostProcessing,updatePostProcessing=a.updatePostProcessing,setupCameraControls=t.setupCameraControls,euler=t.euler,setCanvas(canvas),threeJsLoaded=!0}catch(e){}}async function load3DModules(){if(await loadThreeJS(),!loadModel||!connectWebcam)try{const e=await import("./3d/model.js"),t=await import("./3d/movement.js"),o=await import("./3d/texture.js"),a=await import("./3d/screen-lighting.js"),n=await import("./3d/pulse-audio.js");loadModel=e.loadModel,updateMovement=t.updateMovement,updateRotation=t.updateRotation,fbxMeshes=e.fbxMeshes,glbLights=e.glbLights,getCurrentImageTexture=o.getCurrentImageTexture,getCurrentVideoTexture=o.getCurrentVideoTexture,connectWebcam=o.connectWebcam,loadImage=o.loadImage,loadVideo=o.loadVideo,disconnectWebcam=o.disconnectWebcam,loadDefaultScreenTexture=o.loadDefaultScreenTexture,updateScreenLighting=a.updateScreenLighting,touchMovement=t.touchMovement,updateListenerPosition=n.updateListenerPosition,startAudio=n.startAudio,stopAudio=n.stopAudio,setTouchMovementRef(touchMovement),setAudioFunctions(startAudio,stopAudio),window.loadModel=loadModel,window.connectWebcam=connectWebcam,window.loadImage=loadImage,window.loadVideo=loadVideo,window.disconnectWebcam=disconnectWebcam,window.loadDefaultScreenTexture=loadDefaultScreenTexture}catch(e){}}function setupEventListeners(){let e=null;function t(){return e||(e=document.createElement("input"),e.type="file",e.accept="image/*,video/*",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",async t=>{const o=t.target.files?.[0];o&&(loadImage&&loadVideo||await load3DModules(),o.type.startsWith("image/")?loadImage(o):o.type.startsWith("video/")&&loadVideo(o)),e.value=""})),e}const o=document.getElementById("connect-webcam-link");o&&o.addEventListener("click",async e=>{e.preventDefault(),connectWebcam||await load3DModules(),connectWebcam()});const a=document.getElementById("upload-file-link");a&&a.addEventListener("click",e=>{e.preventDefault(),t().click()});const n=document.getElementById("keyboard-upload-btn");n&&n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),t().click()}),window.resetToDefaults=async function(){try{disconnectWebcam&&loadDefaultScreenTexture||await load3DModules(),disconnectWebcam(),loadDefaultScreenTexture(),resetCamera(startCameraPosition,startCameraRotation,euler),Object.assign(currentCameraPosition,startCameraPosition),Object.assign(currentCameraRotation,startCameraRotation)}catch(e){}};let i=!1;function r(){const e=document.getElementById("keyboard-reset-btn");if(e&&!i){const t=function(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),window.resetToDefaults&&window.resetToDefaults(),!1},o=e.cloneNode(!0);return e.parentNode.replaceChild(o,e),o.onclick=t,o.addEventListener("click",t,{capture:!0,passive:!1}),o.addEventListener("touchend",t,{capture:!0,passive:!1}),i=!0,!0}return!1}const s=async function(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),connectWebcam||await load3DModules(),confirm("Do you want to connect your webcam to the screen?")&&connectWebcam(),!1};window.setupCameraButton=function(){const e=document.getElementById("keyboard-camera-btn");if(e){const t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t.onclick=s,t.addEventListener("click",s,{capture:!0,passive:!1}),t.addEventListener("touchend",s,{capture:!0,passive:!1}),!0}return!1},r(),setupCameraButton(),setTimeout(()=>{document.getElementById("keyboard-reset-btn")||r(),document.getElementById("keyboard-camera-btn")||setupCameraButton()},500);const d=()=>{updateViewportHeightCSS()};window.addEventListener("resize",d),window.visualViewport&&window.visualViewport.addEventListener("resize",d),window.addEventListener("orientationchange",()=>{setTimeout(d,100)}),initTouchControls();const c=document.getElementById("enter-dome-link");c&&c.addEventListener("click",async e=>{e.preventDefault(),startAudio||await load3DModules(),window.enterDomeModeWithAudio&&window.enterDomeModeWithAudio()});const u=async()=>{await loadThreeJS(),setupLighting&&setupLighting(),initPostProcessing&&initPostProcessing(),setupCameraControls&&setupCameraControls(),await load3DModules(),loadModel&&(loadModel(),startRenderLoop())};"requestIdleCallback"in window?requestIdleCallback(()=>u(),{timeout:2e3}):setTimeout(u,500)}function animate(e){if(animationFrameId=requestAnimationFrame(animate),!threeJsLoaded||!camera)return;const t=(e-lastTime)/1e3;if(lastTime=e,updateMovement&&updateRotation&&(updateMovement(),updateRotation(t)),currentCameraPosition.x=camera.position.x,currentCameraPosition.y=camera.position.y,currentCameraPosition.z=camera.position.z,currentCameraRotation.x=camera.rotation.x,currentCameraRotation.y=camera.rotation.y,currentCameraRotation.z=camera.rotation.z,e-lastCameraSaveTime>=2e3&&(Object.assign(startCameraPosition,currentCameraPosition),Object.assign(startCameraRotation,currentCameraRotation),saveSettings(fbxMeshes,glbLights),lastCameraSaveTime=e),getCurrentImageTexture&&updateTextureRotation(t),updateScreenLighting&&updateScreenLighting(e),updateListenerPosition&&THREE&&camera){const e=new THREE.Vector3(0,0,-1);e.applyQuaternion(camera.quaternion),updateListenerPosition({x:camera.position.x,y:camera.position.y,z:camera.position.z},{x:e.x,y:e.y,z:e.z})}updatePostProcessing()}function updateTextureRotation(e){if(!textureRotationSettings.enabled||!THREE||!getCurrentImageTexture)return;const t=getCurrentImageTexture(),o=getCurrentVideoTexture?getCurrentVideoTexture():null,a=t||o;if(a)for(a.center&&.5===a.center.x&&.5===a.center.y||(a.center?a.center.set(.5,.5):a.center=new THREE.Vector2(.5,.5)),a.rotation-=textureRotationSettings.speed*e;a.rotation<0;)a.rotation+=2*Math.PI}function startRenderLoop(){lastTime=performance.now(),animate(lastTime)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{init(),initDomeMode()}):(init(),initDomeMode());