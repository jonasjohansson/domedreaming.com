import{scene,camera,renderer,canvas,resetCamera,setupLighting,initPostProcessing,updatePostProcessing,setupCameraControls,euler}from"./3d/index.js";let loadModel,updateMovement,updateRotation,fbxMeshes,glbLights,getCurrentImageTexture,getCurrentVideoTexture,connectWebcam,loadImage,loadVideo,disconnectWebcam,loadDefaultScreenTexture,updateScreenLighting,touchMovement;import{loadSettings,currentCameraPosition,currentCameraRotation,startCameraPosition,startCameraRotation,saveSettings,textureRotationSettings}from"./core/settings.js";import{initScrollIncrement}from"./layout/scroll-increment.js";import{initGridDotsSystem}from"./layout/grid-dots.js";import{initDashboard}from"./ui/dashboard.js";import{initResponsiveHeights}from"./layout/responsive-height.js";import{updateViewportHeightCSS}from"./core/utils.js";let animationFrameId=null,lastTime=0,lastCameraSaveTime=0;const CAMERA_SAVE_INTERVAL=2e3;function applyDomeDreamingFont(){const e=document.querySelector("main");if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),o=[];let n;for(;n=t.nextNode();)n.parentElement?.classList.contains("dome-dreaming-text")||/dome\s+dreaming/i.test(n.textContent)&&o.push(n);let a=0;o.length>0&&function e(){const t=Math.min(a+5,o.length);for(let e=a;e<t;e++){const t=o[e],n=t.parentNode;if(!n)continue;const a=/(dome\s+dreaming)/gi,i=t.textContent.split(a),r=document.createDocumentFragment();i.forEach(e=>{if(e&&/^dome\s+dreaming$/i.test(e)){const t=document.createElement("span");t.className="dome-dreaming-text",t.textContent=e,r.appendChild(t)}else e&&r.appendChild(document.createTextNode(e))}),n.replaceChild(r,t)}a=t,a<o.length&&("requestIdleCallback"in window?requestIdleCallback(e,{timeout:50}):setTimeout(e,0))}()}async function init(){await new Promise(e=>{"scheduler"in window&&"postTask"in window.scheduler?window.scheduler.postTask(()=>e(),{priority:"user-blocking"}):"requestIdleCallback"in window?requestIdleCallback(()=>e(),{timeout:0}):setTimeout(()=>e(),0)}),await loadSettings(),await new Promise(e=>setTimeout(e,0)),updateViewportHeightCSS(),"requestIdleCallback"in window?requestIdleCallback(()=>{initScrollIncrement(),initResponsiveHeights(),initDashboard()},{timeout:100}):setTimeout(()=>{initScrollIncrement(),initResponsiveHeights(),initDashboard()},0),"requestIdleCallback"in window?requestIdleCallback(()=>{initGridDotsSystem(),applyDomeDreamingFont()},{timeout:500}):setTimeout(()=>{initGridDotsSystem(),applyDomeDreamingFont()},50),"requestIdleCallback"in window?requestIdleCallback(()=>{setupLighting(),initPostProcessing(),setupCameraControls()},{timeout:1e3}):setTimeout(()=>{setupLighting(),initPostProcessing(),setupCameraControls()},100),"requestIdleCallback"in window?requestIdleCallback(()=>{setupEventListeners()},{timeout:100}):setTimeout(()=>{setupEventListeners()},0)}async function load3DModules(){if(!loadModel||!connectWebcam)try{const e=await import("./3d/model.js"),t=await import("./3d/movement.js"),o=await import("./3d/texture.js"),n=await import("./3d/screen-lighting.js");loadModel=e.loadModel,updateMovement=t.updateMovement,updateRotation=t.updateRotation,fbxMeshes=e.fbxMeshes,glbLights=e.glbLights,getCurrentImageTexture=o.getCurrentImageTexture,getCurrentVideoTexture=o.getCurrentVideoTexture,connectWebcam=o.connectWebcam,loadImage=o.loadImage,loadVideo=o.loadVideo,disconnectWebcam=o.disconnectWebcam,loadDefaultScreenTexture=o.loadDefaultScreenTexture,updateScreenLighting=n.updateScreenLighting,touchMovement=t.touchMovement,window.loadModel=loadModel,window.connectWebcam=connectWebcam,window.loadImage=loadImage,window.loadVideo=loadVideo,window.disconnectWebcam=disconnectWebcam,window.loadDefaultScreenTexture=loadDefaultScreenTexture}catch(e){}}function setupEventListeners(){let e=null;function t(){return e||(e=document.createElement("input"),e.type="file",e.accept="image/*,video/*",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",async t=>{const o=t.target.files?.[0];o&&(loadImage&&loadVideo||await load3DModules(),o.type.startsWith("image/")?loadImage(o):o.type.startsWith("video/")&&loadVideo(o)),e.value=""})),e}const o=document.getElementById("connect-webcam-link");o&&o.addEventListener("click",async e=>{e.preventDefault(),connectWebcam||await load3DModules(),connectWebcam()});const n=document.getElementById("upload-file-link");n&&n.addEventListener("click",e=>{e.preventDefault(),t().click()});const a=document.getElementById("keyboard-upload-btn");a&&a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),t().click()}),window.resetToDefaults=async function(){try{disconnectWebcam&&loadDefaultScreenTexture||await load3DModules(),disconnectWebcam(),loadDefaultScreenTexture(),resetCamera(startCameraPosition,startCameraRotation,euler),Object.assign(currentCameraPosition,startCameraPosition),Object.assign(currentCameraRotation,startCameraRotation)}catch(e){}};let i=!1;function r(){const e=document.getElementById("keyboard-reset-btn");if(e&&!i){const t=function(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),window.resetToDefaults&&window.resetToDefaults(),!1},o=e.cloneNode(!0);return e.parentNode.replaceChild(o,e),o.onclick=t,o.addEventListener("click",t,{capture:!0,passive:!1}),o.addEventListener("touchend",t,{capture:!0,passive:!1}),i=!0,!0}return!1}const c=async function(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),connectWebcam||await load3DModules(),confirm("Do you want to connect your webcam to the screen?")&&connectWebcam(),!1};window.setupCameraButton=function(){const e=document.getElementById("keyboard-camera-btn");if(e){const t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t.onclick=c,t.addEventListener("click",c,{capture:!0,passive:!1}),t.addEventListener("touchend",c,{capture:!0,passive:!1}),!0}return!1},r(),setupCameraButton(),setTimeout(()=>{document.getElementById("keyboard-reset-btn")||r(),document.getElementById("keyboard-camera-btn")||setupCameraButton()},500);const s=()=>{updateViewportHeightCSS()};window.addEventListener("resize",s),window.visualViewport&&window.visualViewport.addEventListener("resize",s),window.addEventListener("orientationchange",()=>{setTimeout(s,100)}),document.querySelectorAll(".wasd-key-btn").forEach(e=>{const t=e.getAttribute("data-key");t&&(e.addEventListener("touchstart",o=>{o.preventDefault(),o.stopPropagation(),e.classList.add("active"),"w"===t&&(touchMovement.forward=!0),"s"===t&&(touchMovement.backward=!0),"a"===t&&(touchMovement.left=!0),"d"===t&&(touchMovement.right=!0),"q"===t&&(touchMovement.rotateLeft=!0),"e"===t&&(touchMovement.rotateRight=!0)}),e.addEventListener("touchend",o=>{o.preventDefault(),o.stopPropagation(),e.classList.remove("active"),"w"===t&&(touchMovement.forward=!1),"s"===t&&(touchMovement.backward=!1),"a"===t&&(touchMovement.left=!1),"d"===t&&(touchMovement.right=!1),"q"===t&&(touchMovement.rotateLeft=!1),"e"===t&&(touchMovement.rotateRight=!1)}),e.addEventListener("touchcancel",o=>{o.preventDefault(),o.stopPropagation(),e.classList.remove("active"),"w"===t&&(touchMovement.forward=!1),"s"===t&&(touchMovement.backward=!1),"a"===t&&(touchMovement.left=!1),"d"===t&&(touchMovement.right=!1),"q"===t&&(touchMovement.rotateLeft=!1),"e"===t&&(touchMovement.rotateRight=!1)}),e.addEventListener("mousedown",o=>{o.preventDefault(),o.stopPropagation(),e.classList.add("active"),"w"===t&&(touchMovement.forward=!0),"s"===t&&(touchMovement.backward=!0),"a"===t&&(touchMovement.left=!0),"d"===t&&(touchMovement.right=!0),"q"===t&&(touchMovement.rotateLeft=!0),"e"===t&&(touchMovement.rotateRight=!0)}),e.addEventListener("mouseup",o=>{o.preventDefault(),o.stopPropagation(),e.classList.remove("active"),"w"===t&&(touchMovement.forward=!1),"s"===t&&(touchMovement.backward=!1),"a"===t&&(touchMovement.left=!1),"d"===t&&(touchMovement.right=!1),"q"===t&&(touchMovement.rotateLeft=!1),"e"===t&&(touchMovement.rotateRight=!1)}),e.addEventListener("mouseleave",o=>{e.classList.remove("active"),"w"===t&&(touchMovement.forward=!1),"s"===t&&(touchMovement.backward=!1),"a"===t&&(touchMovement.left=!1),"d"===t&&(touchMovement.right=!1),"q"===t&&(touchMovement.rotateLeft=!1),"e"===t&&(touchMovement.rotateRight=!1)}),e.addEventListener("click",t=>{e.classList.remove("active")}),e.addEventListener("mouseleave",()=>{e.classList.remove("active"),"w"===t&&(touchMovement.forward=!1),"s"===t&&(touchMovement.backward=!1),"a"===t&&(touchMovement.left=!1),"d"===t&&(touchMovement.right=!1),"q"===t&&(touchMovement.rotateLeft=!1),"e"===t&&(touchMovement.rotateRight=!1)}))}),"requestIdleCallback"in window?requestIdleCallback(async()=>{await load3DModules(),loadModel&&(loadModel(),startRenderLoop())},{timeout:2e3}):requestAnimationFrame(async()=>{setTimeout(async()=>{await load3DModules(),loadModel&&(loadModel(),startRenderLoop())},100)})}function animate(e){animationFrameId=requestAnimationFrame(animate);const t=(e-lastTime)/1e3;lastTime=e,updateMovement&&updateRotation&&updateMovement&&updateRotation&&(updateMovement(),updateRotation(t)),currentCameraPosition.x=camera.position.x,currentCameraPosition.y=camera.position.y,currentCameraPosition.z=camera.position.z,currentCameraRotation.x=camera.rotation.x,currentCameraRotation.y=camera.rotation.y,currentCameraRotation.z=camera.rotation.z,e-lastCameraSaveTime>=2e3&&(Object.assign(startCameraPosition,currentCameraPosition),Object.assign(startCameraRotation,currentCameraRotation),saveSettings(fbxMeshes,glbLights),lastCameraSaveTime=e),updateTextureRotation(t),updateScreenLighting(e),updatePostProcessing()}function updateTextureRotation(e){if(!textureRotationSettings.enabled)return;const t=getCurrentImageTexture(),o=getCurrentVideoTexture(),n=t||o;if(n)for(n.center&&.5===n.center.x&&.5===n.center.y||(n.center?n.center.set(.5,.5):n.center=new THREE.Vector2(.5,.5)),n.rotation-=textureRotationSettings.speed*e;n.rotation<0;)n.rotation+=2*Math.PI}function startRenderLoop(){lastTime=performance.now(),animate(lastTime)}function initDomeMode(){const e=document.getElementById("keyboard-exit-btn"),t=document.body;let o=!1;function n(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0}function a(){e&&(t.classList.contains("dome-mode")?n()?(e.textContent="exit",e.style.display="flex"):e.style.display="none":(e.textContent="enter",e.style.display="flex",e.disabled=!1,e.style.pointerEvents="auto"))}function i(e=!1){if(t.classList.contains("dome-mode"))return;t.classList.add("dome-mode"),document.documentElement.style.overflow="hidden",a();const n=document.getElementById("canvas-container");if(n){const e=getComputedStyle(document.documentElement).getPropertyValue("--actual-vh");n.style.height=e||"100vh",n.style.width="100vw",setTimeout(()=>{window.dispatchEvent(new Event("resize"))},0)}const i=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0;if(e&&canvas&&!i&&document.pointerLockElement!==canvas&&document.mozPointerLockElement!==canvas&&document.webkitPointerLockElement!==canvas){const e=setTimeout(()=>{if(!t.classList.contains("dome-mode")||o)return;const e=canvas.requestPointerLock||canvas.mozRequestPointerLock||canvas.webkitRequestPointerLock;if(e)try{e.call(canvas).catch(e=>{"SecurityError"!==e.name&&e.name})}catch(e){"SecurityError"!==e.name&&e.name}},100);window.pointerLockTimeout=e}setTimeout(()=>{window.setupCameraButton&&window.setupCameraButton()},150)}function r(){if(!o){if(o=!0,window.pointerLockTimeout&&(clearTimeout(window.pointerLockTimeout),window.pointerLockTimeout=null),canvas&&(document.pointerLockElement===canvas||document.mozPointerLockElement===canvas||document.webkitPointerLockElement===canvas))try{document.exitPointerLock()}catch(e){e.name}if(t.classList.contains("dome-mode")){t.classList.remove("dome-mode"),document.documentElement.style.overflow="auto";const e=document.getElementById("canvas-container");e&&(e.style.width=""),a(),setTimeout(()=>{window.setupCameraButton&&window.setupCameraButton(),setTimeout(()=>{o=!1},100)},0)}else o=!1}}function c(){if(o)return;const e=canvas&&(document.pointerLockElement===canvas||document.mozPointerLockElement===canvas||document.webkitPointerLockElement===canvas),n=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0;e||!t.classList.contains("dome-mode")||n||setTimeout(()=>{!o&&t.classList.contains("dome-mode")&&document.pointerLockElement!==canvas&&document.mozPointerLockElement!==canvas&&document.webkitPointerLockElement!==canvas&&r()},50)}window.enterDomeModeFromCanvas=()=>{i(!0)},e&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.contains("dome-mode")?n()&&r():i(!0)}),e.addEventListener("touchend",e=>{e.stopPropagation(),e.preventDefault(),t.classList.contains("dome-mode")?n()&&r():i(!0)})),a(),document.addEventListener("keydown",e=>{if("Escape"===e.key&&t.classList.contains("dome-mode")&&r(),!t.classList.contains("dome-mode")||"BODY"===document.activeElement.tagName)if("u"===e.key||"U"===e.key){const t=document.getElementById("keyboard-upload-btn");t&&!t.disabled&&(e.preventDefault(),t.click())}else if("c"===e.key||"C"===e.key){const t=document.getElementById("keyboard-camera-btn");t&&!t.disabled&&(e.preventDefault(),t.click())}}),document.addEventListener("pointerlockchange",c),document.addEventListener("mozpointerlockchange",c),document.addEventListener("webkitpointerlockchange",c)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{init(),initDomeMode()}):(init(),initDomeMode());