import*as l from"three";import{EffectComposer as Nt}from"three/addons/postprocessing/EffectComposer.js";import{RenderPass as _t}from"three/addons/postprocessing/RenderPass.js";import{UnrealBloomPass as Bt}from"three/addons/postprocessing/UnrealBloomPass.js";import"three/addons/postprocessing/OutputPass.js";import"three/addons/postprocessing/FXAAPass.js";import{GLTFLoader as gt}from"three/addons/loaders/GLTFLoader.js";import{DRACOLoader as Ot}from"three/addons/loaders/DRACOLoader.js";import{init as Gt,importNavMesh as qt,NavMeshQuery as ht}from"@recast-navigation/core";import{threeToSoloNavMesh as Ut}from"@recast-navigation/three";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();const G=new l.Scene;G.background=new l.Color(1710618);const d=new l.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);d.position.set(0,5.4,-4.3);d.rotation.set(-3,0,3.121154018741333);const T=new l.WebGLRenderer({antialias:!1,powerPreference:"high-performance",stencil:!1,depth:!0}),pt=document.getElementById("canvas-container");function wt(){const e=pt.getBoundingClientRect();return{width:e.width,height:e.height}}const Re=wt();T.setSize(Re.width,Re.height);T.setPixelRatio(Math.min(window.devicePixelRatio,1.5));d.aspect=Re.width/Re.height;d.updateProjectionMatrix();setTimeout(()=>{window.dispatchEvent(new Event("resize"))},100);T.shadowMap.enabled=!1;T.toneMapping=l.NoToneMapping;T.outputColorSpace=l.SRGBColorSpace;pt.appendChild(T.domElement);const v=T.domElement;let Pe=()=>{const e=wt();d.aspect=e.width/e.height,d.updateProjectionMatrix(),T.setSize(e.width,e.height),T.setPixelRatio(Math.min(window.devicePixelRatio,1.5))};window.addEventListener("resize",Pe);function Yt(e){window.removeEventListener("resize",Pe),Pe=e,window.addEventListener("resize",Pe)}function Je(){const e=new l.AmbientLight(16777215,.2);G.add(e),G.fog=new l.Fog(1710618,20,60)}const Xt="modulepreload",Qt=function(e){return"/"+e},Ze={},vt=function(n,o,t){let i=Promise.resolve();if(o&&o.length>0){let f=function(p){return Promise.all(p.map(L=>Promise.resolve(L).then(r=>({status:"fulfilled",value:r}),r=>({status:"rejected",reason:r}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),c=a?.nonce||a?.getAttribute("nonce");i=f(o.map(p=>{if(p=Qt(p),p in Ze)return;Ze[p]=!0;const L=p.endsWith(".css"),r=L?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${r}`))return;const m=document.createElement("link");if(m.rel=L?"stylesheet":Xt,L||(m.as="script"),m.crossOrigin="",m.href=p,c&&m.setAttribute("nonce",c),document.head.appendChild(m),L)return new Promise((g,u)=>{m.addEventListener("load",g),m.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${p}`)))})}))}function s(a){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=a,window.dispatchEvent(c),!c.defaultPrevented)throw a}return i.then(a=>{for(const c of a||[])c.status==="rejected"&&s(c.reason);return n().catch(s)})},N=1.6,Ce={x:5,y:10,z:5},re={emissive:new l.Color(16777215),emissiveIntensity:1,color:new l.Color(16777215),toneMapped:!1,transparent:!1,opacity:1};function Ie(e,n){if(!n)return;const o=Array.isArray(n.material)?n.material[0]:n.material;if(!o){n.material=new l.MeshStandardMaterial({map:e,emissiveMap:e,...re});return}o.map&&o.map.dispose(),o.emissiveMap&&o.emissiveMap.dispose(),o.map=e,o.emissiveMap=e,Object.assign(o,re),o.needsUpdate=!0}function ze(e){e.flipY=!0,e.wrapS=l.RepeatWrapping,e.wrapT=l.RepeatWrapping,e.repeat.x=-1,e.colorSpace=l.SRGBColorSpace,e.center.set(.5,.5),e.needsUpdate=!0}function ae(e){return Array.isArray(e.material)?e.material[0]:e.material}function yt(e){!e||!e.children||(e.children=e.children.filter(Boolean),e.children.forEach(n=>yt(n)))}function j(e,n){if(!e)return;const o=[e];for(;o.length;){const t=o.pop();if(t&&(n(t),t.children&&t.children.length))for(let i=t.children.length-1;i>=0;i--){const s=t.children[i];s&&typeof s.traverse=="function"?o.push(s):t.children.splice(i,1)}}}let Ke={cameraHeight:1.6,navmeshSearchBox:{x:5,y:10,z:5},screenMaterialSettings:{emissive:[1,1,1],emissiveIntensity:1,color:[1,1,1],toneMapped:!1,transparent:!1,opacity:1},ledCount:384,ledRadius:.03},Ye=.02,ne={sensitivity:.002,rotationSpeed:120},De={x:0,y:5.4,z:-4.3},$e={x:-3,y:0,z:3.121154018741333},Ee={x:0,y:0,z:0},Se={x:0,y:0,z:0},B={enabled:!0,strength:1.5,radius:.4,threshold:.85},y={pulseSpeed:2,pulseWidth:.3,baseIntensity:0,maxIntensity:4,mirrored:!1,rimVisible:!1,hueStart:.5,hueRange:.3,saturation:1,lightness:.5},F={backgroundColor:"#000000",textColor:"#ffffff",dotColor:"#ffffff",sidebarColor:"#333333",sidebarVisible:!0,headerIslandVisible:!1,blendMode:"normal",vignette:{enabled:!1,size:8,fadeWidth:2}},Xe={enabled:!0,scrollTimeout:25,touchThreshold:30,snapThreshold:.5,initialSnapThreshold:1,gridColumns:16,gridRows:16},bt={rows:8},Qe={defaultImage:"assets/img/background-text.jpg"},Q={enabled:!0,speed:.02},_={canvas:{backgroundColor:"#000000",backgroundImage:null},about:{backgroundColor:"#463434",backgroundImage:null},team:{backgroundColor:"#000000",backgroundImage:null}};async function Jt(e=!1){try{const n=new URL(import.meta.url),o=new URL("default-settings.json",n);console.log("Loading default-settings.json from:",o.href);const t=e?`${o}?t=${Date.now()}`:o,i=await fetch(t);if(!i.ok)return console.warn("Could not load default-settings.json, using hardcoded defaults"),!1;const s=await i.json();return s.constants&&(Ke={...Ke,...s.constants}),s.settings&&(Lt(s.settings),console.log("Default settings loaded from JSON file")),!0}catch(n){return console.warn("Failed to load default settings from JSON:",n),!1}}function Lt(e){e.moveSpeed!==void 0&&(Ye=e.moveSpeed),e.cameraSettings&&Object.assign(ne,e.cameraSettings),e.startCameraPosition&&Object.assign(De,e.startCameraPosition),e.startCameraRotation&&Object.assign($e,e.startCameraRotation),e.colorSettings?window.savedColorSettings=e.colorSettings:window.savedColorSettings=null,e.lightSettings?window.savedLightSettings=e.lightSettings:window.savedLightSettings=null,e.bloomSettings&&(Object.assign(B,e.bloomSettings),console.log("Bloom settings loaded from JSON:",B)),e.ledStripSettings&&Object.assign(y,e.ledStripSettings),e.pageColorSettings&&(e.pageColorSettings.vignette&&(F.vignette={...F.vignette,...e.pageColorSettings.vignette}),Object.assign(F,e.pageColorSettings),F.vignette||(F.vignette={enabled:!0,size:8,fadeWidth:2}),ke()),e.scrollSettings&&Object.assign(Xe,e.scrollSettings),e.canvasSettings&&Object.assign(bt,e.canvasSettings),e.screenSettings&&Object.assign(Qe,e.screenSettings),e.textureRotationSettings&&Object.assign(Q,e.textureRotationSettings),e.pageBackgroundSettings&&(Object.assign(_,e.pageBackgroundSettings),Et())}function Zt(e,n=.5){if(!e)return null;if(e.startsWith("rgba"))return e;if(e.startsWith("rgb")){const t=e.match(/\d+/g);if(t&&t.length>=3)return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${n})`}const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(o){const t=parseInt(o[1],16),i=parseInt(o[2],16),s=parseInt(o[3],16);return`rgba(${t}, ${i}, ${s}, ${n})`}return e}function Et(){const e=document.querySelectorAll(".page-section");if(e.length>0&&e.length>1&&_.team)for(let n=1;n<e.length;n++){const o=e[n];if(_.team.backgroundColor&&_.team.backgroundColor!=="#000000"){const t=Zt(_.team.backgroundColor,.5);o.style.setProperty("background-color",t,"important")}else o.style.removeProperty("background-color");_.team.backgroundImage?(o.style.setProperty("background-image",`url(${_.team.backgroundImage})`,"important"),o.style.setProperty("background-size","cover","important"),o.style.setProperty("background-position","center","important"),o.style.setProperty("background-repeat","no-repeat","important")):o.style.removeProperty("background-image")}}function Kt(){const e=document.getElementById("canvas-container");if(!e)return;const n=F.vignette||{enabled:!0,size:8,fadeWidth:2};if(!n.enabled){e.style.maskImage="none",e.style.webkitMaskImage="none";return}const o=`${n.size}%`,t=`${n.size+n.fadeWidth}%`,i=`${n.size+n.fadeWidth*2}%`,s=`${100-n.size-n.fadeWidth*2}%`,a=`${100-n.size-n.fadeWidth}%`,c=`${100-n.size}%`,f=`linear-gradient(to right, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${t}, black ${i}, black ${s}, rgba(0, 0, 0, 0.5) ${a}, transparent ${c}, transparent 100%)`,p=`linear-gradient(to bottom, transparent 0%, transparent ${o}, rgba(0, 0, 0, 0.5) ${t}, black ${i}, black ${s}, rgba(0, 0, 0, 0.5) ${a}, transparent ${c}, transparent 100%)`;e.style.maskImage=`${f}, ${p}`,e.style.maskComposite="intersect",e.style.webkitMaskImage=`${f}, ${p}`,e.style.webkitMaskComposite="source-in"}function ke(){document.documentElement.style.setProperty("--color-bg",F.backgroundColor),document.documentElement.style.setProperty("--color-text",F.textColor),document.documentElement.style.setProperty("--color-dot",F.dotColor),Kt()}async function en(e=!1){const n=await Jt(e);if(!n&&!e)try{const o=localStorage.getItem("domeDreamingSettings");if(!o){ke();return}const t=JSON.parse(o);Lt(t),console.log("Loaded settings from localStorage (JSON file not available)")}catch(o){console.warn("Failed to load settings from localStorage:",o),ke()}else n&&(console.log("Loaded settings from data.json"),ke());Et()}function St(e,n){try{const o={};e&&Array.isArray(e)&&e.forEach((s,a)=>{const c=ae(s.mesh);if(c?.color){const f=s.name||`mesh_${a}`;o[f]={r:c.color.r,g:c.color.g,b:c.color.b}}});const t={};n&&Array.isArray(n)&&n.forEach((s,a)=>{const c=s.name||`light_${a}`;t[c]={r:s.color.r,g:s.color.g,b:s.color.b,intensity:s.intensity}});const i={moveSpeed:Ye,cameraSettings:ne,startCameraPosition:De,startCameraRotation:$e,colorSettings:o,lightSettings:t,bloomSettings:B,ledStripSettings:y,pageColorSettings:F,scrollSettings:Xe,canvasSettings:bt,screenSettings:Qe,textureRotationSettings:Q,pageBackgroundSettings:_};localStorage.setItem("domeDreamingSettings",JSON.stringify(i))}catch(o){console.warn("Failed to save settings:",o)}}let Y=null,et=null,pe=null;function tt(){const n=document.getElementById("canvas-container").getBoundingClientRect(),o=new l.Vector2(n.width,n.height),t=new l.WebGLRenderTarget(o.width,o.height,{type:l.HalfFloatType,samples:0});Y=new Nt(T,t),et=new _t(G,d),Y.addPass(et);const i=B.enabled!==!1?B.strength:0;pe=new Bt(o,i,B.radius,B.threshold),pe.enabled=B.enabled!==!1,Y.addPass(pe),Yt(()=>{const a=document.getElementById("canvas-container").getBoundingClientRect(),c=a.width,f=a.height;d.aspect=c/f,d.updateProjectionMatrix(),T.setSize(c,f),T.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),nn()}),console.log("Post-processing initialized")}function tn(){Y?Y.render():T.render(G,d)}function nn(){if(Y){const n=document.getElementById("canvas-container").getBoundingClientRect(),o=n.width,t=n.height;Y.setSize(o,t),pe&&pe.setSize(o,t)}}let x=null,D=null,M=null,$=null,Me=null;function nt(e){x=e}function on(){return D}function sn(){return $}function rn(e=Qe.defaultImage||"assets/media/background.jpg"){if(!x)return;new l.TextureLoader().load(e,o=>{ze(o),o.rotation=0,Ie(o,x),$=o},void 0,()=>{})}function Mt(e){if(!x)return;const n=new FileReader;n.onload=o=>{new l.TextureLoader().load(o.target.result,i=>{D&&(D.dispose(),D=null),M&&(M.pause(),M.src="",URL.revokeObjectURL(M.src),M=null),$&&$.dispose(),Q.enabled=!1,ze(i),i.rotation=0,Ie(i,x),$=i;const s=ae(x);s&&setTimeout(()=>{Object.assign(s,re),s.needsUpdate=!0},200)},void 0,()=>{})},n.readAsDataURL(e)}function xt(e){if(!x)return;const n=document.createElement("video");n.src=URL.createObjectURL(e),n.crossOrigin="anonymous",n.loop=!0,n.muted=!0,n.playsInline=!0,n.addEventListener("loadedmetadata",()=>{n.play(),D&&D.dispose(),M&&(M.pause(),M.src="",URL.revokeObjectURL(M.src)),$&&($.dispose(),$=null),Q.enabled=!1;const o=new l.VideoTexture(n);ze(o),o.minFilter=l.LinearFilter,o.magFilter=l.LinearFilter,o.rotation=0,Ie(o,x),D=o,M=n;const t=ae(x);t&&setTimeout(()=>{Object.assign(t,re),t.needsUpdate=!0},200)}),n.addEventListener("error",()=>{})}function an(){if(x){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("Webcam access is not available in your browser.");return}navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(e=>{D&&(D.dispose(),D=null),M&&(M.pause(),M.srcObject=null,M=null),$&&($.dispose(),$=null),Me&&(Me.getTracks().forEach(o=>o.stop()),Me=null),Q.enabled=!1;const n=document.createElement("video");n.srcObject=e,n.autoplay=!0,n.playsInline=!0,n.muted=!0,n.addEventListener("loadedmetadata",()=>{n.play();const o=new l.VideoTexture(n);ze(o),o.minFilter=l.LinearFilter,o.magFilter=l.LinearFilter,o.rotation=0,Ie(o,x),D=o,M=n,Me=e;const t=ae(x);t&&setTimeout(()=>{Object.assign(t,re),t.needsUpdate=!0},200)}),n.addEventListener("error",()=>{alert("Error accessing webcam.")})}).catch(e=>{console.error("Error accessing webcam:",e),alert("Could not access webcam. Please check permissions.")})}}function ln(){const e=document.getElementById("drop-zone");function n(t){t.preventDefault(),t.stopPropagation()}function o(t){if(!x)return;const i=ae(x);i&&(t?(i.emissive=new l.Color(38655),i.emissiveIntensity=.8):(Object.assign(i,re),i.needsUpdate=!0))}document.addEventListener("dragenter",t=>{n(t),e.classList.add("drag-over"),o(!0)},!1),document.addEventListener("dragover",t=>{n(t),e.classList.add("drag-over"),o(!0)},!1),document.addEventListener("dragleave",t=>{n(t),t.clientX===0&&t.clientY===0&&(e.classList.remove("drag-over"),o(!1))},!1),document.addEventListener("drop",t=>{n(t),e.classList.remove("drag-over"),o(!1);const i=t.dataTransfer.files;if(i.length>0){const s=i[0];s.type.startsWith("image/")?Mt(s):s.type.startsWith("video/")&&xt(s)}},!1)}let we=!1,fe=null,He=[],J=null;function cn(){return J}async function Pt(){if(!we)try{await Gt(),we=!0,dn()}catch(e){console.error("Failed to initialize recast-navigation:",e),we=!0}}async function dn(){if(!we){await Pt();return}try{const e=await fetch("assets/models/navmesh.bin");if(e.ok){const n=await e.arrayBuffer(),o=new Uint8Array(n),{navMesh:t}=qt(o);J=new ht(t),$t(J),console.log("Navmesh loaded from navmesh.bin"),O&&Ct();return}}catch{console.log("navmesh.bin not found, will generate from GLTF")}un()}function un(){new gt().load("assets/models/navmesh.gltf",async n=>{if(fe=n.scene,fe.scale.setScalar(1),fe.visible=!1,j(fe,o=>{o.isMesh&&(He.push(o),o.updateMatrixWorld())}),G.add(fe),He.length>0&&we){const{success:o,navMesh:t}=Ut(He,{cs:.05,ch:.05,walkableRadius:.2});o&&(J=new ht(t),$t(J),console.log("Navmesh generated from GLTF"))}},void 0,n=>{console.warn("Navmesh GLTF not found:",n)})}function Ct(){if(!J||!O)return;const e={x:d.position.x,y:d.position.y-N,z:d.position.z},n=J.findClosestPoint(e,{halfExtents:Ce});n.success&&(d.position.y=n.point.y+N)}function mn(){Pt().catch(console.error)}let X=null,k=[],W=null;const b=384,ge=.03;let ee=0,Ae=2,be=.3,ie=0,Ve=4,Fe=!1,R={hueStart:.5,hueRange:.3,saturation:1,lightness:.5};function fn(){Ae=y.pulseSpeed,be=y.pulseWidth,ie=y.baseIntensity,Ve=y.maxIntensity,Fe=y.mirrored||!1,R.hueStart=y.hueStart,R.hueRange=y.hueRange,R.saturation=y.saturation,R.lightness=y.lightness;const e=y.rimVisible!==void 0?y.rimVisible:!1;It(e)}function gn(e){Ae=e,y.pulseSpeed=e,le()}function hn(e){be=e,y.pulseWidth=e,le()}function pn(e){ie=e,y.baseIntensity=e,le()}function wn(e){Ve=e,y.maxIntensity=e,le()}function vn(e,n,o,t){R.hueStart=e,R.hueRange=n,R.saturation=o,R.lightness=t,y.hueStart=e,y.hueRange=n,y.saturation=o,y.lightness=t,le()}function yn(e){Fe=e,y.mirrored=e,le()}function le(){vt(()=>Promise.resolve().then(()=>Pn),void 0).then(e=>{St(e.fbxMeshes,e.glbLights)})}function kt(e){if(!e)return console.warn("findLEDRim: model is null"),null;let n=null;const o=[];return e.traverse(t=>{o.push(t.name||"unnamed");const i=t.name||"",s=i.toLowerCase();(i==="LED_Rim"||i.includes("LED_Rim")||i.includes("LEDRim")||i.includes("led_rim")||s.includes("ledrim")||s.includes("led")&&s.includes("rim"))&&(n=t,console.log(`Found LED rim object: "${t.name}", type: ${t.type||t.constructor.name}`))}),n||console.warn("LED_Rim object not found. Available object names:",o.filter(t=>t).slice(0,20)),n}function Rt(e){if(!e){console.warn("LED_Rim object not found");return}X=e,W=new l.Group,W.name="LED_Strip";let n=null;e.traverse(u=>{u.isMesh&&u.geometry&&(n=u.geometry)});const o=new l.Box3;o.setFromObject(e);const t=o.getSize(new l.Vector3);o.getCenter(new l.Vector3);let i=Math.max(t.x,t.z)/2;const s=t.y/2;let a=i*.75;i<.1&&(console.warn(`LED Rim radius too small (${i.toFixed(2)}), using default 5.0`),i=5,a=3.5),console.log(`LED Rim dimensions: outerRadius=${i.toFixed(2)}, innerRadius=${a.toFixed(2)}, height=${s.toFixed(2)}, size:`,t),console.log("Rim object position:",e.position),console.log("Rim object rotation:",e.rotation),console.log("Rim object scale:",e.scale),console.log("Rim object matrix:",e.matrix);let c=[];if(n&&n.attributes&&n.attributes.position){const u=n.attributes.position,w=u.count;console.log(`Found rim geometry with ${w} vertices`);const S=[];for(let h=0;h<w;h++){const P=u.getX(h),ce=u.getY(h),z=u.getZ(h);S.push(new l.Vector3(P,ce,z))}const A=Math.min(...S.map(h=>h.y)),Z=Math.max(...S.map(h=>h.y)),q=Z-A,K=A+q*.1;console.log(`Rim Y range: ${A.toFixed(2)} to ${Z.toFixed(2)}, using bottom Y: ${K.toFixed(2)}`);const I=S.filter(h=>Math.abs(h.y-K)<q*.15).map(h=>{const P=Math.sqrt(h.x*h.x+h.z*h.z);return{vertex:h,distance:P,angle:Math.atan2(h.z,h.x)}}).sort((h,P)=>h.angle-P.angle);if(I.length>10){console.log(`Found ${I.length} bottom edge vertices`);const h=I.reduce((z,V)=>z+V.vertex.x,0)/I.length,P=I.reduce((z,V)=>z+V.vertex.z,0)/I.length,ce=K;new l.Vector3(h,ce,P),I.reduce((z,V)=>{const de=V.vertex.x-h,ue=V.vertex.z-P;return z+Math.sqrt(de*de+ue*ue)},0)/I.length;for(let z=0;z<b;z++){const V=z/b*Math.PI*2;let de=I[0],ue=1/0;for(const We of I){const jt=Math.atan2(We.vertex.z-P,We.vertex.x-h);let me=Math.abs(jt-V);me>Math.PI&&(me=Math.PI*2-me),me<ue&&(ue=me,de=We)}const Ht=new l.Vector3(h+Math.cos(V)*a,de.vertex.y,P+Math.sin(V)*a);c.push(Ht)}console.log(`Created ${c.length} evenly distributed LED positions using angular distribution`)}else{console.log(`Not enough bottom vertices (${I.length}), using perfectly evenly distributed circle positions`);for(let h=0;h<b;h++){const P=h/b*Math.PI*2,ce=new l.Vector3(Math.cos(P)*a,K,Math.sin(P)*a);c.push(ce)}}}else{console.log("No rim geometry found, using perfectly evenly distributed circle positions");for(let u=0;u<b;u++){const w=u/b*Math.PI*2,S=new l.Vector3(Math.cos(w)*a,-s,Math.sin(w)*a);c.push(S)}}if(c.length!==b){console.log(`Adjusting positions from ${c.length} to ${b} for even distribution`);const u=[];for(let w=0;w<b;w++){const S=w/b,A=Math.floor(S*c.length),Z=(A+1)%c.length,q=S*c.length-A,K=new l.Vector3().lerpVectors(c[A],c[Z],q);u.push(K)}c=u}const f=new l.CylinderGeometry(ge*.8,ge*.8,ge*.3,8,1),p=new l.MeshStandardMaterial({color:16777215,emissive:65535,emissiveIntensity:0,metalness:0,roughness:.8}),L=new l.Group;L.name="LED_Diffuser";const r=new l.TorusGeometry(a+ge*.2,ge*.15,16,64),m=new l.MeshStandardMaterial({color:16777215,transparent:!0,opacity:.3,roughness:1,metalness:0,side:l.DoubleSide}),g=new l.Mesh(r,m);if(g.position.y=-s,g.rotation.x=Math.PI/2,L.add(g),c.length!==b){for(console.warn(`Position count mismatch: ${c.length} positions, need ${b}. Creating missing positions.`);c.length<b;){const w=c.length/b*Math.PI*2,S=new l.Vector3(Math.cos(w)*a,-s,Math.sin(w)*a);c.push(S)}c=c.slice(0,b)}for(let u=0;u<b&&u<c.length;u++){const w=new l.Mesh(f,p.clone());w.position.copy(c[u]);const S=new l.Vector3(0,c[u].y,0);w.lookAt(S),w.rotateX(Math.PI/2),w.name=`LED_${u}`,k.push({mesh:w,index:u,material:w.material}),W.add(w)}if(e.add(W),e.add(L),W.visible=!0,W.matrixAutoUpdate=!0,console.log(`Created LED strip with ${k.length} pixels (target: ${b}) at inner radius ${a.toFixed(2)}`),console.log(`Positions array length: ${c.length}`),k.length!==b?console.error(`LED count mismatch! Expected ${b}, got ${k.length}`):console.log(`âœ“ Successfully created all ${b} LEDs`),console.log("LED strip group position (local):",W.position),console.log("LED strip group visible:",W.visible),console.log("Rim object visible:",e.visible),k.length>0){const u=k[0].mesh,w=new l.Vector3;u.getWorldPosition(w);const S=new l.Vector3;e.getWorldPosition(S);const A=new l.Quaternion;if(e.getWorldQuaternion(A),console.log("First LED local position:",u.position),console.log("First LED world position:",w),console.log("Rim object world position:",S),console.log("Rim object world rotation:",e.getWorldQuaternion(A)),console.log("Rim object world scale:",e.getWorldScale(new l.Vector3)),k.length>10){const Z=k[Math.floor(k.length/4)].mesh,q=new l.Vector3;Z.getWorldPosition(q),console.log("Quarter LED world position:",q)}}}function Tt(e){k.length!==0&&(ee+=e*Ae,k.forEach((n,o)=>{const t=o/b;let i;if(Fe){const L=t-.5,r=Math.abs(L),m=(.5-r+ee)%1,g=(.5-r-ee+1)%1;i=Math.min(m,g)}else i=(t+ee)%1;const s=Math.abs(i-.5)*2;let a=0;s<be?(a=1-s/be,a=Math.pow(a,2),a=ie+(Ve-ie)*a):a=ie,n.material.emissiveIntensity=Math.max(a,0);const c=ee*.1,f=(R.hueStart+(t+ee*.5)*R.hueRange+c)%1,p=new l.Color().setHSL(f,R.saturation,R.lightness);n.material.emissive=p,n.mesh.visible=!0}))}function bn(e){k.forEach(n=>{n.material.emissive.set(e)})}function Ln(e){k.forEach(n=>{n.material.emissiveIntensity=e})}function En(){return W}function Sn(){return X}function It(e){X&&(X.visible=e,X.traverse(n=>{n.isMesh&&(n.visible=e)}))}function Mn(){return X?X.visible:!0}const xn=Object.freeze(Object.defineProperty({__proto__:null,get baseIntensity(){return ie},colorPalette:R,createLEDStrip:Rt,findLEDRim:kt,getLEDStrip:En,getRimObject:Sn,isRimVisible:Mn,loadLEDStripSettings:fn,get maxIntensity(){return Ve},get mirrored(){return Fe},get pulseSpeed(){return Ae},get pulseWidth(){return be},setBaseIntensity:pn,setColorPalette:vn,setLEDColor:bn,setLEDIntensity:Ln,setMaxIntensity:wn,setMirrored:yn,setPulseSpeed:gn,setPulseWidth:hn,setRimVisible:It,updateLEDAnimation:Tt},Symbol.toStringTag,{value:"Module"}));let zt=null,ve=[],H=[],te=null,Dt=[];function Be(){const e=new gt,n=new Ot;n.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/libs/draco/gltf/"),e.setDRACOLoader(n);const o=document.getElementById("loading");e.load("assets/models/wisdome.glb",t=>{if(console.log("Wisdome GLB loaded successfully"),!t||!t.scene){console.error("GLB loaded but scene is missing"),o.innerHTML='<div style="color: #ff4444;">Error: Model scene is missing.</div>';return}const i=t.scene;zt=i,i.scale.setScalar(1),i.position.set(0,0,0),yt(i),te=new l.Group,te.name="GLBLights";const s=()=>{j(i,r=>{r.isLight&&(H.push(r),te.add(r),console.log("Found GLB light:",r.name||"Unnamed",r.type,"intensity:",r.intensity))})};"requestIdleCallback"in window?requestIdleCallback(s,{timeout:100}):s(),H.length===0&&(console.log("No lights found with isLight, checking object for light instances..."),j(i,r=>{(r instanceof l.Light||r instanceof l.DirectionalLight||r instanceof l.PointLight||r instanceof l.SpotLight||r instanceof l.RectAreaLight||r instanceof l.HemisphereLight)&&(H.includes(r)||(H.push(r),te.add(r),console.log("Found additional light:",r.name||"Unnamed",r.constructor.name)))})),H.length>0?(G.add(te),console.log(`Grouped ${H.length} lights from GLB`),window.savedLightSettings&&H.forEach((r,m)=>{const g=r.name||`light_${m}`,u=window.savedLightSettings[g];if(u){r.color.setRGB(u.r,u.g,u.b);const w=Math.max(0,Math.min(u.intensity??r.intensity,10));r.intensity=w}})):console.log("No lights found in GLB file. Lights GUI will not be available."),j(i,r=>{r.name==="Hotspots"&&j(r,m=>{if(m.name==="Hotspot.001"||m.name.includes("Hotspot")){const g=new l.Vector3;m.getWorldPosition(g),Dt.push({object:m,position:g,name:m.name,triggered:!1}),console.log(`Found hotspot: ${m.name} at position:`,g)}})});const a=kt(i);a?(console.log("Found LED_Rim object, creating LED strip..."),vt(()=>Promise.resolve().then(()=>xn),void 0).then(r=>{r.loadLEDStripSettings()}),Rt(a)):console.log("LED_Rim object not found in model"),j(i,r=>{if(r.isMesh){const m=r.name.toLowerCase();if(m.includes("led_rim")||m.includes("led_strip")||m.startsWith("led_"))return;if(m.includes("screen")||m.includes("display")||m.includes("monitor")||m.includes("panel")||m.includes("projection")||m.includes("canvas"))nt(r),r.visible=!0;else{let g=ae(r);const u=g?.color?g.color.clone():new l.Color(16777215);if(g){if(g.metalness!==void 0&&(g.metalness=Math.max(g.metalness||0,.1)),g.roughness!==void 0&&(g.roughness=Math.min(g.roughness||.5,.8)),g.map&&(g.map.colorSpace=l.SRGBColorSpace),g.isMeshBasicMaterial){const w=new l.MeshStandardMaterial({color:g.color,map:g.map,transparent:g.transparent,opacity:g.opacity,metalness:.1,roughness:.5});r.material=w,g=w}g.needsUpdate=!0}ve.push({mesh:r,name:r.name||"Unnamed",originalColor:u})}}});let c=!1;j(i,r=>{r.isMesh&&r.name&&(r.name.toLowerCase().includes("screen")||r.name.toLowerCase().includes("display")||r.name.toLowerCase().includes("monitor")||r.name.toLowerCase().includes("panel")||r.name.toLowerCase().includes("projection")||r.name.toLowerCase().includes("canvas"))&&(c=!0)}),!c&&i&&i.children.length>0&&j(i,r=>{r.isMesh&&!c&&(nt(r),r.visible=!0,ve=ve.filter(m=>m.mesh!==r),c=!0)}),G.add(i),setTimeout(()=>{o.classList.add("hidden");const r=document.getElementById("canvas-container"),m=document.getElementById("info-panel");r&&r.classList.add("loaded"),m&&m.classList.add("loaded")},300);const f=De||{x:0,y:5.4,z:-4.3},p=$e||{x:-3,y:0,z:3.121154018741333};d.position.set(f.x,f.y,f.z),d.rotation.set(p.x,p.y,p.z),d.updateMatrixWorld(),C.setFromQuaternion(d.quaternion),kn(!0),cn()&&Ct(),mn(),rn(),ln()},void 0,t=>{console.error("Error loading 3D model:",t),o.innerHTML='<div style="color: #ff4444;">Error loading 3D model.</div>'})}const Pn=Object.freeze(Object.defineProperty({__proto__:null,get fbxMeshes(){return ve},glbLights:H,get glbLightsGroup(){return te},hotspots:Dt,loadModel:Be,get wisdomeModel(){return zt}},Symbol.toStringTag,{value:"Module"}));let he=null,E={forward:!1,backward:!1,left:!1,right:!1};function $t(e){he=e}function Cn(){if(!O)return;d.updateMatrixWorld();const e=new l.Vector3;e.setFromMatrixColumn(d.matrixWorld,2),e.multiplyScalar(-1).normalize();const n=new l.Vector3;n.setFromMatrixColumn(d.matrixWorld,0),n.normalize();const o=new l.Vector3,t=Ye;oe.w&&o.add(e.clone().multiplyScalar(t)),oe.s&&o.add(e.clone().multiplyScalar(-t)),oe.a&&o.add(n.clone().multiplyScalar(-t)),oe.d&&o.add(n.clone().multiplyScalar(t));const i=t*2;if(E.forward&&o.add(e.clone().multiplyScalar(i)),E.backward&&o.add(e.clone().multiplyScalar(-i)),E.left&&o.add(n.clone().multiplyScalar(-i)),E.right&&o.add(n.clone().multiplyScalar(i)),o.length()!==0)if(he){const s=d.position.clone();s.x+=o.x,s.z+=o.z;const a={x:s.x,y:s.y-N,z:s.z},c=he.findClosestPoint(a,{halfExtents:Ce});if(c.success)d.position.set(c.point.x,c.point.y+N,c.point.z);else{const f=he.findClosestPoint({x:s.x,y:d.position.y-N,z:d.position.z},{halfExtents:Ce});if(f.success)d.position.set(f.point.x,f.point.y+N,d.position.z);else{const p=he.findClosestPoint({x:d.position.x,y:d.position.y-N,z:s.z},{halfExtents:Ce});p.success&&d.position.set(d.position.x,p.point.y+N,p.point.z)}}}else d.position.add(o)}let xe=!1,C=new l.Euler(-3,0,3.121154018741333,"YXZ"),O=!1,je=0,Ne=0,oe={};function kn(e){O=e}function ot(){function e(){const t=xe;xe=document.pointerLockElement===v||document.mozPointerLockElement===v||document.webkitPointerLockElement===v,!t&&xe&&O&&C.setFromQuaternion(d.quaternion)}document.addEventListener("pointerlockchange",e),document.addEventListener("mozpointerlockchange",e),document.addEventListener("webkitpointerlockchange",e);function n(t){if(!xe||!O)return;const i=t.movementX||t.mozMovementX||t.webkitMovementX||0,s=t.movementY||t.mozMovementY||t.webkitMovementY||0;C.y-=i*ne.sensitivity,C.x-=s*ne.sensitivity,C.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,C.x)),d.quaternion.setFromEuler(C)}v.addEventListener("mousemove",n);let o=null;v.addEventListener("touchstart",t=>{if(!(!document.body.classList.contains("dome-mode")||!O)){if(t.preventDefault(),t.touches.length===1&&o===null){const i=t.touches[0];o=i.identifier,je=i.clientX,Ne=i.clientY,C.setFromQuaternion(d.quaternion)}t.touches.length===2&&(E.forward=!0)}},{passive:!1}),v.addEventListener("touchmove",t=>{if(!(!document.body.classList.contains("dome-mode")||!O)){if(t.preventDefault(),o!==null){const i=Array.from(t.touches).find(s=>s.identifier===o);if(i){const s=i.clientX-je,a=i.clientY-Ne;C.y-=s*ne.sensitivity,C.x-=a*ne.sensitivity,C.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,C.x)),d.quaternion.setFromEuler(C),je=i.clientX,Ne=i.clientY}}t.touches.length===2?(E.forward=!0,E.backward=!1,E.left=!1,E.right=!1):t.touches.length===1&&(E.forward=!1)}},{passive:!1}),v.addEventListener("touchend",t=>{if(document.body.classList.contains("dome-mode")){t.preventDefault();for(let i=0;i<t.changedTouches.length;i++)t.changedTouches[i].identifier===o&&(o=null);t.touches.length<2&&(E.forward=!1,E.backward=!1,E.left=!1,E.right=!1)}},{passive:!1}),v.addEventListener("touchcancel",t=>{if(document.body.classList.contains("dome-mode")){t.preventDefault();for(let i=0;i<t.changedTouches.length;i++)t.changedTouches[i].identifier===o&&(o=null);E.forward=!1,E.backward=!1,E.left=!1,E.right=!1}},{passive:!1}),window.addEventListener("keydown",t=>{oe[t.key.toLowerCase()]=!0,(t.key==="c"||t.key==="C")&&(console.log("Camera Position:",d.position),console.log("Camera Rotation:",d.rotation))}),window.addEventListener("keyup",t=>{oe[t.key.toLowerCase()]=!1,t.key==="q"||t.key==="Q"||t.key==="e"||t.key})}function At(){return window.visualViewport&&window.visualViewport.height?window.visualViewport.height:document.documentElement.clientHeight||window.innerHeight}function it(){const e=At();document.documentElement.style.setProperty("--actual-vh",`${e}px`)}function Le(){const e=getComputedStyle(document.documentElement),n=e.getPropertyValue("--row-height"),o=parseFloat(n);if(!isNaN(o)&&o>0)return o;const t=parseFloat(e.getPropertyValue("--grid-rows"))||16;return At()/t}let ye=!1,st=0;const Rn=50;let rt=0,Oe=0,U=0;function Vt(e){const n=Le();return Math.round(e/n)*n}function Ge(){if(ye)return;const e=window.pageYOffset||document.documentElement.scrollTop,n=Vt(e);Math.abs(e-n)>1&&(ye=!0,window.scrollTo({top:n,behavior:"auto"}),setTimeout(()=>{ye=!1},50))}function Tn(){if(ye)return;const e=window.pageYOffset||document.documentElement.scrollTop,n=Vt(e),t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?5:1;Math.abs(e-n)>t&&Ge()}function Ft(e){const n=Date.now();if(n-st<Rn)return;const o=Le(),t=window.pageYOffset||document.documentElement.scrollTop;if(e!==0){const a=(Math.round(t/o)+e)*o,c=Math.max(document.body.scrollHeight-window.innerHeight,document.documentElement.scrollHeight-window.innerHeight),f=Math.max(0,Math.min(a,c));Math.abs(f-t)>1&&(st=n,window.scrollTo({top:f,behavior:"auto"}))}}function In(e){if(document.body.classList.contains("dome-mode"))return;e.preventDefault();const n=e.deltaY;let o=0;n>0?o=1:n<0&&(o=-1),o!==0&&Ft(o)}function zn(e){document.body.classList.contains("dome-mode")||e.touches.length===1&&(rt=e.touches[0].clientY,Oe=rt,U=0)}function Dn(e){if(document.body.classList.contains("dome-mode")||e.touches.length!==1)return;e.preventDefault();const n=e.touches[0].clientY,o=Oe-n;U+=o,Oe=n;const i=Le()*.3;if(Math.abs(U)>=i){const s=U>0?1:-1;Ft(s),U=U%i}}function $n(e){document.body.classList.contains("dome-mode")||(e.preventDefault(),U=0)}function An(){if(!Xe.enabled||document.body.classList.contains("dome-mode"))return;window.addEventListener("wheel",In,{passive:!1}),document.addEventListener("touchstart",zn,{passive:!1}),document.addEventListener("touchmove",Dn,{passive:!1}),document.addEventListener("touchend",$n,{passive:!1});let e=null;window.addEventListener("scroll",()=>{if(ye)return;e&&clearTimeout(e),e=setTimeout(()=>{Tn(),e=null},50)},{passive:!0}),window.addEventListener("load",()=>{setTimeout(()=>{Ge()},100)}),window.addEventListener("resize",()=>{setTimeout(()=>{Ge()},100)})}let se=null,at=16;function Vn(){const e=document.getElementById("dots");e&&e.remove(),se=document.createElement("div"),se.id="dots",document.body.appendChild(se),qe(),Ue()}function qe(){const e=getComputedStyle(document.documentElement);document.documentElement.clientWidth||window.innerWidth,e.getPropertyValue("--col-width"),e.getPropertyValue("--row-height")}function Ue(){if(!se)return;se.innerHTML="";const e=16;for(let n=0;n<e;n++)for(let o=0;o<at;o++){const t=document.createElement("div");t.className="dot",t.dataset.col=o+1,t.dataset.row=n+1,t.style.gridColumn=o+1,t.style.gridRow=n+1,t.style.pointerEvents="none";const i=o+1,s=n+1,a=i+(s-1)*at;t.style.setProperty("--dot-delay",a),se.appendChild(t)}}function Fn(){Vn();let e;const n=()=>{clearTimeout(e),e=setTimeout(()=>{qe(),Ue()},150)};window.addEventListener("resize",n),window.addEventListener("orientationchange",()=>{setTimeout(()=>{qe(),Ue()},300)})}function lt(e){document.querySelectorAll(".dashboard-block.active, .page-content .block.active").forEach(n=>{n.classList.remove("active")}),e.classList.add("active")}function Wn(){document.querySelectorAll(".dashboard-block").forEach(o=>{o.addEventListener("click",()=>{lt(o)})}),document.querySelectorAll(".page-content .block img").forEach(o=>{const t=o.closest(".block");t&&t.addEventListener("click",()=>{lt(t)})})}function ct(){const e=document.querySelectorAll(".block.responsive"),n=Le(),t=window.innerWidth<=768?12:10,i=n*t;e.forEach(s=>{s.style.height=`${i}px`,s.style.minHeight=`${i}px`})}function _e(){if(!(window.innerWidth<=768)){document.querySelectorAll(".page-content.responsive").forEach(s=>{const a=s.closest(".page-section");a&&(a.style.height="",a.style.minHeight="")});return}const n=document.querySelectorAll(".page-content.responsive"),o=Le(),t=10;n.forEach(i=>{const s=i.closest(".page-section");if(!s)return;s.style.height="auto",s.style.minHeight="auto";const a=i.offsetHeight,c=o*t;if(a>c){const f=Math.ceil(a/o);s.style.height=`calc(var(--row-height) * ${f})`,s.style.minHeight=`calc(var(--row-height) * ${f})`}else s.style.height=`calc(var(--row-height) * ${t})`,s.style.minHeight=`calc(var(--row-height) * ${t})`})}function Hn(){ct(),_e();let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{ct(),_e()},100)}),window.addEventListener("load",()=>{_e()})}let Te=0,dt=0;const jn=2e3;function Nn(){const e=document.querySelector("main");if(!e)return;const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),o=[];let t;for(;t=n.nextNode();)t.parentElement?.classList.contains("dome-dreaming-text")||/dome\s+dreaming/i.test(t.textContent)&&o.push(t);o.forEach(i=>{const s=i.parentNode;if(!s)return;const a=i.textContent,c=/(dome\s+dreaming)/gi,f=a.split(c),p=document.createDocumentFragment();f.forEach(L=>{if(L&&/^dome\s+dreaming$/i.test(L)){const r=document.createElement("span");r.className="dome-dreaming-text",r.textContent=L,p.appendChild(r)}else L&&p.appendChild(document.createTextNode(L))}),s.replaceChild(p,i)})}async function ut(){await en(),it(),An(),Fn(),Hn(),Wn(),Nn(),"requestIdleCallback"in window?requestIdleCallback(()=>{Je(),tt(),ot()},{timeout:1e3}):setTimeout(()=>{Je(),tt(),ot(),initParallaxLayer()},50);const e=document.getElementById("connect-webcam-link");e&&e.addEventListener("click",t=>{t.preventDefault(),an()});const n=document.getElementById("upload-file-link");if(n){const t=document.createElement("input");t.type="file",t.accept="image/*,video/*",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",i=>{const s=i.target.files?.[0];s&&(s.type.startsWith("image/")?Mt(s):s.type.startsWith("video/")&&xt(s)),t.value=""}),n.addEventListener("click",i=>{i.preventDefault(),t.click()})}const o=()=>{it()};window.addEventListener("resize",o),window.visualViewport&&window.visualViewport.addEventListener("resize",o),window.addEventListener("orientationchange",()=>{setTimeout(o,100)}),"requestIdleCallback"in window?requestIdleCallback(()=>{Be(),mt()},{timeout:2e3}):requestAnimationFrame(()=>{setTimeout(()=>{Be(),mt()},100)})}function Wt(e){requestAnimationFrame(Wt);const n=(e-Te)/1e3;Te=e,Cn(),Ee.x=d.position.x,Ee.y=d.position.y,Ee.z=d.position.z,Se.x=d.rotation.x,Se.y=d.rotation.y,Se.z=d.rotation.z,e-dt>=jn&&(Object.assign(De,Ee),Object.assign($e,Se),St(ve,H),dt=e),Tt(n),_n(n),tn()}function _n(e){if(!Q.enabled)return;const n=sn(),o=on(),t=n||o;if(t)for((!t.center||t.center.x!==.5||t.center.y!==.5)&&(t.center?t.center.set(.5,.5):t.center=new THREE.Vector2(.5,.5)),t.rotation-=Q.speed*e;t.rotation<0;)t.rotation+=Math.PI*2}function mt(){Te=performance.now(),Wt(Te)}function ft(){const e=document.getElementById("enter-dome-btn"),n=document.body;function o(s=!1){if(n.classList.contains("dome-mode"))return;n.classList.add("dome-mode"),document.documentElement.style.overflow="hidden";const a=document.getElementById("canvas-container");if(a){const f=getComputedStyle(document.documentElement).getPropertyValue("--actual-vh");a.style.height=f||"100vh",a.style.width="100vw",setTimeout(()=>{window.dispatchEvent(new Event("resize"))},0)}const c=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0;s&&v&&!c&&setTimeout(()=>{const f=v.requestPointerLock||v.mozRequestPointerLock||v.webkitRequestPointerLock;f&&f.call(v)},100)}function t(){if(v&&(document.pointerLockElement===v||document.mozPointerLockElement===v||document.webkitPointerLockElement===v)&&document.exitPointerLock(),n.classList.contains("dome-mode")){n.classList.remove("dome-mode"),document.documentElement.style.overflow="auto";const s=document.getElementById("canvas-container");s&&(s.style.width="")}}window.enterDomeModeFromCanvas=()=>{o(!0)},e&&v&&(e.addEventListener("click",s=>{s.stopPropagation(),o(!0)}),e.addEventListener("touchend",s=>{s.stopPropagation(),s.preventDefault(),o(!0)})),document.addEventListener("keydown",s=>{s.key==="Escape"&&n.classList.contains("dome-mode")&&(!v||document.pointerLockElement!==v&&document.mozPointerLockElement!==v&&document.webkitPointerLockElement!==v?t():document.exitPointerLock())});function i(){const s=v&&(document.pointerLockElement===v||document.mozPointerLockElement===v||document.webkitPointerLockElement===v),a=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0;!s&&n.classList.contains("dome-mode")&&!a&&t()}document.addEventListener("pointerlockchange",i),document.addEventListener("mozpointerlockchange",i),document.addEventListener("webkitpointerlockchange",i)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ut(),ft()}):(ut(),ft());
